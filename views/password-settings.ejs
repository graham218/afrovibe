<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <!-- keep your head partial so fonts/meta/CSP stay consistent -->
  <%- include('partials/head.ejs', { pageTitle: 'Password Settings' }) %>

  <body class="min-h-screen flex flex-col bg-[#000] text-white relative isolation-isolate">
    <!-- navbar stays on top of any page overlays -->
    <%- include('partials/navbar.ejs') %>

    <!-- subtle page glow (doesn‚Äôt touch navbar/footer) -->
    <div aria-hidden="true"
         class="pointer-events-none absolute inset-0 -z-10
                bg-[radial-gradient(60%_50%_at_50%_0%,rgba(255,107,107,.12),transparent_60%),radial-gradient(60%_40%_at_80%_100%,rgba(254,202,87,.10),transparent_60%)]">
    </div>

    <main class="flex-1">
      <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
        <!-- header -->
        <div class="mb-6 md:mb-8">
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
            <span class="bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
              Password Settings
            </span>
          </h1>
          <p class="mt-2 text-sm text-white/80">
            Update your password. Use at least 8 characters with a mix of letters, numbers and symbols.
          </p>
        </div>

        <!-- main glass card -->
        <div class="rounded-3xl bg-black/60 backdrop-blur-xl border border-white/10 shadow-[0_12px_40px_-12px_rgba(0,0,0,.65)]">
          <div class="p-5 md:p-8 space-y-6">
            <!-- current password badge (for UX copy only; not revealing actual) -->
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm">
                <div class="text-white/70">Account</div>
                <div class="mt-1 font-semibold break-all">
                  <span class="px-2.5 py-1 rounded-full text-sm
                               bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] text-black">
                    <%= currentUser && currentUser.email ? currentUser.email : 'Your account' %>
                  </span>
                </div>
              </div>

              <a href="/forgot" class="btn btn-ghost btn-sm rounded-full text-white/80 hover:bg-white/10">
                Forgot Password?
              </a>
            </div>

            <!-- form -->
            <!-- If your original route differs, keep it; otherwise /update-password is conventional -->
            <form id="passwordForm" class="space-y-5" method="post" action="/update-password">
              <!-- current password -->
              <label class="form-control w-full">
                <span class="label-text mb-1 text-white/80">Current password</span>
                <div class="relative">
                  <input
                    type="password"
                    name="currentPassword"
                    id="currentPassword"
                    required
                    autocomplete="current-password"
                    class="input input-bordered w-full bg-black/40 text-black placeholder-white/40
                           border-white/20 pr-12
                           focus:border-transparent focus:outline-none focus:ring-2 focus:ring-[#FF6B6B]"
                    placeholder="Enter your current password" />
                  <button type="button"
                          id="toggleCur"
                          class="absolute right-2.5 top-1/2 -translate-y-1/2 text-black/70 hover:text-black"
                          aria-label="Show/Hide current password">
                    üëÅ
                  </button>
                </div>
              </label>

              <!-- new password -->
              <label class="form-control w-full">
                <span class="label-text mb-1 text-white/80">New password</span>
                <div class="relative">
                  <input
                    type="password"
                    name="newPassword"
                    id="newPassword"
                    required
                    autocomplete="new-password"
                    class="input input-bordered w-full bg-black/40 text-black placeholder-white/40
                           border-white/20 pr-12
                           focus:border-transparent focus:outline-none focus:ring-2 focus:ring-[#FECA57]"
                    placeholder="Create a strong password" />
                  <button type="button"
                          id="toggleNew"
                          class="absolute right-2.5 top-1/2 -translate-y-1/2 text-black/70 hover:text-black"
                          aria-label="Show/Hide new password">
                    üëÅ
                  </button>
                </div>
                <!-- strength meter -->
                <div class="mt-2">
                  <div class="h-2 w-full rounded-full bg-white/10 overflow-hidden">
                    <div id="pwBar"
                         class="h-2 w-0 rounded-full
                                bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
                                transition-all duration-300"></div>
                  </div>
                  <div id="pwMsg" class="mt-1 text-xs text-white/70">Strength: ‚Äî</div>
                </div>
              </label>

              <!-- confirm password -->
              <label class="form-control w-full">
                <span class="label-text mb-1 text-white/80">Confirm new password</span>
                <div class="relative">
                  <input
                    type="password"
                    name="confirmPassword"
                    id="confirmPassword"
                    required
                    autocomplete="new-password"
                    class="input input-bordered w-full bg-black/40 text-black placeholder-white/40
                           border-white/20 pr-12
                           focus:border-transparent focus:outline-none focus:ring-2 focus:ring-[#FF6B6B]"
                    placeholder="Repeat your new password" />
                  <button type="button"
                          id="toggleConf"
                          class="absolute right-2.5 top-1/2 -translate-y-1/2 text-black/70 hover:text-black"
                          aria-label="Show/Hide confirm password">
                    üëÅ
                  </button>
                </div>
                <p id="matchHint" class="mt-1 text-xs text-white/70 hidden">Passwords match ‚úÖ</p>
                <p id="matchErr"  class="mt-1 text-xs text-rose-400 hidden">Passwords do not match.</p>
              </label>

              <!-- actions -->
              <div class="flex items-center justify-between gap-3 pt-1">
                <a href="/settings"
                   class="btn btn-ghost rounded-full text-white/80 hover:bg-white/10">
                  ‚Üê Back to Settings
                </a>

                <button type="submit"
                        id="submitBtn"
                        class="btn rounded-full text-black border-0
                               bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
                               hover:shadow-xl hover:scale-[1.02] transition disabled:opacity-50"
                        disabled>
                  <span class="inline-flex items-center gap-2">
                    <span id="spinner" class="hidden loading loading-spinner loading-xs" aria-hidden="true"></span>
                    Save password
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- small tips -->
        <div class="mt-6 rounded-2xl bg-black/50 backdrop-blur-xl border border-white/10 p-4 text-xs text-white/70">
          <div class="font-semibold mb-1">Tips</div>
          <ul class="list-disc pl-5 space-y-1">
            <li>Use at least 8 characters.</li>
            <li>Mix uppercase, lowercase, numbers, and symbols.</li>
            <li>Don‚Äôt reuse your old password.</li>
          </ul>
        </div>
      </section>
    </main>

    <%- include('partials/footer.ejs') %>

    <!-- simple alert modal (CSP-safe, no inline handlers) -->
    <dialog id="alertModal" class="modal">
      <div class="modal-box bg-black/70 backdrop-blur-2xl border border-white/10 rounded-3xl text-white">
        <h3 id="alertTitle" class="font-bold text-lg bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
          Notice
        </h3>
        <p id="alertMessage" class="py-3 text-white/90">‚Äî</p>
        <div class="modal-action">
          <button class="btn rounded-full text-black border-0 bg-gradient-to-r from-[#FECA57] to-[#FF6B6B]" data-modal-close>
            Close
          </button>
        </div>
      </div>
    </dialog>

    <!-- scripts (no inline handlers; CSP-friendly) -->
    <script>
      // modal helpers
      function showAlertModal(title, message) {
        const m = document.getElementById('alertModal');
        const t = document.getElementById('alertTitle');
        const b = document.getElementById('alertMessage');
        if (!m) return;
        if (t) t.textContent = title || 'Notice';
        if (b) b.textContent = message || '';
        try { m.showModal(); } catch {}
      }
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-modal-close]');
        if (!btn) return;
        btn.closest('dialog')?.close();
      });

      // eye toggles
      (function (){
        const pairs = [
          ['toggleCur','currentPassword'],
          ['toggleNew','newPassword'],
          ['toggleConf','confirmPassword'],
        ];
        for (const [tId,iId] of pairs) {
          const t = document.getElementById(tId);
          const i = document.getElementById(iId);
          if (!t || !i) continue;
          t.addEventListener('click', () => { i.type = i.type === 'password' ? 'text' : 'password'; });
        }
      })();

      // strength + match checks
      const newInput  = document.getElementById('newPassword');
      const confInput = document.getElementById('confirmPassword');
      const curInput  = document.getElementById('currentPassword');
      const pwBar  = document.getElementById('pwBar');
      const pwMsg  = document.getElementById('pwMsg');
      const okMsg  = document.getElementById('matchHint');
      const errMsg = document.getElementById('matchErr');
      const submit = document.getElementById('submitBtn');

      function scorePassword(pw) {
        let s = 0;
        if (!pw) return 0;
        if (pw.length >= 8) s += 1;
        if (/[A-Z]/.test(pw)) s += 1;
        if (/[a-z]/.test(pw)) s += 1;
        if (/[0-9]/.test(pw)) s += 1;
        if (/[^A-Za-z0-9]/.test(pw)) s += 1;
        if (pw.length >= 12) s += 1;
        return Math.min(s, 6);
      }
      function updateStrength() {
        const pw = newInput?.value || '';
        const sc = scorePassword(pw);
        const pct = (sc / 6) * 100;
        if (pwBar) pwBar.style.width = pct + '%';
        if (pwMsg) {
          const labels = ['‚Äî','Very weak','Weak','Fair','Good','Strong','Great'];
          pwMsg.textContent = 'Strength: ' + labels[sc];
        }
      }
      function updateMatch() {
        const a = (newInput?.value || '');
        const b = (confInput?.value || '');
        const match = a.length > 0 && a === b;
        okMsg?.classList.toggle('hidden', !match);
        errMsg?.classList.toggle('hidden', !a || match);
        // enable submit only when: all present + match + reasonable strength
        const strongEnough = scorePassword(a) >= 3;
        const ready = !!(curInput?.value && a && b && match && strongEnough);
        if (ready) submit?.removeAttribute('disabled'); else submit?.setAttribute('disabled','true');
      }
      newInput?.addEventListener('input', () => { updateStrength(); updateMatch(); });
      confInput?.addEventListener('input', updateMatch);
      curInput?.addEventListener('input',  updateMatch);

      // submit (AJAX to stay on page; form still has action as fallback)
      (function () {
        const form = document.getElementById('passwordForm');
        const spn  = document.getElementById('spinner');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          const currentPassword = String(fd.get('currentPassword') || '').trim();
          const newPassword     = String(fd.get('newPassword') || '').trim();
          const confirmPassword = String(fd.get('confirmPassword') || '').trim();

          if (!currentPassword || !newPassword || !confirmPassword) {
            showAlertModal('Error', 'Please fill in all fields.'); return;
          }
          if (newPassword !== confirmPassword) {
            showAlertModal('Error', 'Passwords do not match.'); return;
          }

          submit?.setAttribute('disabled','true');
          spn?.classList.remove('hidden');

          try {
            const res = await fetch(form.getAttribute('action') || '/update-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              credentials: 'same-origin',
              body: new URLSearchParams({ currentPassword, newPassword, confirmPassword }).toString()
            });
            const json = await res.json().catch(() => ({}));
            if (res.ok && (json?.success || json?.ok)) {
              showAlertModal('Success', json?.message || 'Password updated.');
              setTimeout(() => location.href = '/settings', 1200);
            } else {
              showAlertModal('Error', json?.message || 'Could not update password.');
            }
          } catch {
            showAlertModal('Error', 'Network error. Please try again.');
          } finally {
            spn?.classList.add('hidden');
            submit?.removeAttribute('disabled');
          }
        });
      })();

      // motion safety for prefers-reduced-motion users
      try {
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          document.querySelectorAll('*').forEach(el => el.classList.remove('transition','animate-pulse'));
        }
      } catch {}
    </script>
  </body>
</html>
