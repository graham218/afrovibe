<!-- views/partials/navbar.ejs -->
<header class="navbar sticky top-0 bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] shadow-md px-3 md:px-4 z-40 isolation-isolate"
        role="banner" aria-label="Primary">
  <!-- Left: brand + mobile menu -->
  <div class="navbar-start">
    <!-- Mobile hamburger -->
    <div class="dropdown">
      <label tabindex="0"
             class="btn btn-ghost lg:hidden text-black hover:scale-105 transition"
             aria-label="Open menu">
        <!-- hamburger -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </label>

      <!-- Mobile dropdown (forced dark glass: readable on every page) -->
      <ul tabindex="0"
          class="menu menu-sm dropdown-content mt-3 z-[200] p-2 shadow rounded-3xl w-64
                 bg-black/95 text-white border border-white/10 backdrop-blur-xl">
        <li><a class="text-[18px] font-medium hover:bg-white/10" href="/dashboard">Home</a></li>

        <li>
          <a class="text-[18px] font-medium hover:bg-white/10" href="/messages">
            Messages
            <span class="badge badge-error text-[14px] font-bold nav-unread-messages ml-2
                         <%= (typeof unreadMessages !== 'undefined' && unreadMessages > 0) ? '' : 'hidden' %>">
              <%= typeof unreadMessages !== 'undefined' && unreadMessages > 0 ? unreadMessages : '' %>
            </span>
          </a>
        </li>

        <li><a class="text-[18px] font-medium hover:bg-white/10" href="/matches">Matches</a></li>

        <!-- Connections group -->
        <li>
          <details>
            <summary class="text-[18px] font-medium">Connections</summary>
            <ul class="p-2 bg-transparent">
              <li><a class="hover:bg-white/10" href="/likes-you">Likes You</a></li>
              <li><a class="hover:bg-white/10" href="/favorites">Favorites</a></li>
              <li><a class="hover:bg-white/10" href="/viewed-you">Views</a></li>
              <li><a class="hover:bg-white/10" href="/blocked">Blocked</a></li>
            </ul>
          </details>
        </li>

        <li><a class="text-[18px] font-medium hover:bg-white/10" href="/advanced-search">Advanced Search</a></li>
        <li><a class="text-[18px] font-medium hover:bg-white/10" href="/settings">Settings</a></li>

        <!-- Mobile notifications entry -->
        <li class="md:hidden">
          <a class="text-[18px] font-medium hover:bg-white/10" href="/notifications">
            Notifications
            <span class="badge badge-error text-[14px] font-bold nav-unread-notifs ml-2
                         <%= (typeof unreadNotificationCount !== 'undefined' && unreadNotificationCount > 0) ? '' : 'hidden' %>">
              <%= typeof unreadNotificationCount !== 'undefined' && unreadNotificationCount > 0 ? unreadNotificationCount : '' %>
            </span>
          </a>
        </li>

        <% const boostActiveMobile = currentUser && currentUser.boostExpiresAt && new Date(currentUser.boostExpiresAt) > new Date(); %>
        <% if (boostActiveMobile) { %>
          <li class="opacity-90">
            <a class="hover:bg-white/10" href="javascript:void(0)">
              Boosting
              <span id="boostCountdownMobile" class="ml-1 font-mono text-xs"
                    data-expires="<%= new Date(currentUser.boostExpiresAt).toISOString() %>">--:--</span>
            </a>
          </li>
        <% } %>

        <li><a class="text-[18px] font-medium hover:bg-white/10" href="/logout">Logout</a></li>
      </ul>
    </div>

    <!-- Brand (override DaisyUI btn sizing) -->
<a href="/dashboard"
   class="btn btn-ghost normal-case whitespace-nowrap
          !p-0 !h-auto !min-h-0 !bg-transparent hover:!bg-transparent
          !text-4xl sm:!text-5xl lg:!text-6xl !leading-[0.95]
          text-black tracking-tight font-extrabold
          hover:scale-[1.03] transition">
  üåç AfroVibe
</a>


  </div>

  <!-- Center: desktop menu (black text works over bright gradient) -->
  <div class="navbar-center hidden lg:flex">
    <ul class="menu menu-horizontal px-1 gap-1">
      <li><a href="/dashboard" class="text-black text-[18px] font-semibold hover:text-black/80">Home</a></li>

      <li>
        <a href="/messages" class="text-black text-[18px] font-semibold hover:text-black/80">
          Messages
          <span class="badge badge-error text-[14px] font-bold ml-2 nav-unread-messages
                       <%= (typeof unreadMessages !== 'undefined' && unreadMessages > 0) ? '' : 'hidden' %>">
            <%= typeof unreadMessages !== 'undefined' && unreadMessages > 0 ? unreadMessages : '' %>
          </span>
        </a>
      </li>

      <li><a href="/matches" class="text-black text-[18px] font-semibold hover:text-black/80">Matches</a></li>

      <!-- Desktop: Connections dropdown (forced dark glass) -->
      <li class="dropdown dropdown-hover">
        <label tabindex="0" class="text-black text-[18px] font-semibold hover:text-black/80">Connections</label>
        <ul tabindex="0"
            class="dropdown-content menu p-2 rounded-3xl w-60 z-[200]
                   bg-black/95 text-white border border-white/10 backdrop-blur-xl">
          <li><a class="hover:bg-white/10" href="/likes-you">Likes You</a></li>
          <li><a class="hover:bg-white/10" href="/favorites">Favorites</a></li>
          <li><a class="hover:bg-white/10" href="/viewed-you">Views</a></li>
          <li><a class="hover:bg-white/10" href="/blocked">Blocked</a></li>
        </ul>
      </li>

      <li><a href="/advanced-search" class="text-black text-[18px] font-semibold hover:text-black/80">Advanced Search</a></li>
      <li><a href="/settings" class="text-black text-[18px] font-semibold hover:text-black/80">Settings</a></li>
    </ul>
  </div>

  <!-- Right: boost badge, notifications, streak/likes, avatar -->
  <div class="navbar-end gap-1 md:gap-2">
    <% const boostActive = currentUser && currentUser.boostExpiresAt && new Date(currentUser.boostExpiresAt) > new Date(); %>
    <% if (boostActive) { %>
      <div class="mr-1 hidden md:flex items-center">
        <span class="badge badge-warning text-black font-bold rounded-full">
          Boosting
          <span id="boostCountdown" class="ml-1 font-mono"
                data-expires="<%= new Date(currentUser.boostExpiresAt).toISOString() %>">--:--</span>
        </span>
      </div>
    <% } %>

    <!-- Notifications (desktop) -->
    <div class="hidden md:flex items-center mr-1">
      <a href="/notifications" class="btn btn-ghost btn-circle text-black hover:scale-105 transition"
         aria-label="Notifications">
        <div class="indicator">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5" />
          </svg>
          <span class="badge badge-error text-[12px] font-bold indicator-item nav-unread-notifs
                       <%= (typeof unreadNotificationCount !== 'undefined' && unreadNotificationCount > 0) ? '' : 'hidden' %>">
            <%= typeof unreadNotificationCount !== 'undefined' && unreadNotificationCount > 0 ? unreadNotificationCount : '' %>
          </span>
        </div>
      </a>
    </div>

    <% if (typeof likesRemaining !== 'undefined' || typeof streak !== 'undefined') { %>
      <div class="hidden md:flex items-center gap-3 mr-1 text-black/90">
        <% if (typeof streak !== 'undefined') { %>
          <div class="flex items-center gap-2">
            <span class="text-[12px] font-semibold">Streak <%= streak.day %>/<%= streak.target %></span>
            <div class="w-20 h-1 bg-black/30 rounded-full overflow-hidden">
              <div style="width:<%= streak.percentage %>%;" class="h-1 bg-black"></div>
            </div>
          </div>
        <% } %>

        <% if (typeof likesRemaining !== 'undefined') { %>
          <div class="text-[12px] font-semibold">
            Likes: <span class="font-extrabold"><%= likesRemaining >= 0 ? likesRemaining : '‚àû' %></span>
          </div>
        <% } %>
      </div>
    <% } %>

    <!-- Upgrade CTA (kept in gradient style) -->
    <a href="/upgrade"
       class="btn btn-sm rounded-full bg-black/10 text-black border-black/20 hover:bg-black/20 hidden md:inline-flex">
      <span>Upgrade</span>
      <span class="ml-1">üëë</span>
    </a>

    <!-- Avatar -->
    <div class="dropdown dropdown-end">
      <label tabindex="0" class="btn btn-ghost btn-circle avatar" aria-label="Open profile menu">
        <div class="w-10 h-10 rounded-full ring-1 ring-black/40 overflow-hidden">
          <% if (currentUser?.profile?.photos?.length) { %>
            <img src="<%= currentUser.profile.photos[0] %>" alt="Profile"
                 class="w-full h-full object-cover"
                 onerror="this.src='/images/default-avatar.png';">
          <% } else { %>
            <img src="/images/default-avatar.png" alt="Profile" class="w-full h-full object-cover">
          <% } %>
        </div>
      </label>

      <!-- Avatar dropdown (forced dark glass) -->
      <ul tabindex="0"
          class="menu menu-sm dropdown-content mt-3 z-[200] p-2 shadow rounded-3xl w-60
                 bg-black/95 text-white border border-white/10 backdrop-blur-xl">
        <li class="font-semibold px-3 py-1"><%= currentUser?.username || 'Profile' %></li>
        <li><a class="hover:bg-white/10" href="/my-profile">My Profile</a></li>
        <li><a class="hover:bg-white/10" href="/edit-profile">Edit Profile</a></li>
        <li><a class="hover:bg-white/10" href="/photos">Manage Photos</a></li>
        <li><a class="hover:bg-white/10" href="/settings">Settings</a></li>
        <% if (boostActive) { %>
          <li class="opacity-90">
            <a class="hover:bg-white/10" href="javascript:void(0)">
              Boosting
              <span id="boostCountdownMenu" class="ml-1 font-mono text-xs"
                    data-expires="<%= new Date(currentUser.boostExpiresAt).toISOString() %>">--:--</span>
            </a>
          </li>
        <% } %>
        <li><a class="hover:bg-white/10" href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
</header>

<!-- Sockets: official client + your helper + global nav logic -->
<script src="/socket.io/socket.io.js" defer></script>
<script src="/js/socket.helper.js" defer></script>
<script src="/js/global.js" defer></script>

<!-- Inline nav counters & boost timers (kept; CSP nonce-ready) -->
<script nonce="<%= (typeof cspNonce !== 'undefined' && cspNonce) ? cspNonce : '' %>">
(function () {
  if (typeof io !== 'function') return;

  var socket = window.__appSocket || (window.__appSocket = io({ withCredentials:true }));
  var myId = '<%= currentUser?._id %>' || '';
  if (myId) { try { socket.emit('register_for_notifications', myId); } catch (e) {} }

  function setBadge(nodes, n){
    var v = Math.max(0, Number(n) || 0);
    nodes.forEach(function(el){
      if (!el) return;
      el.textContent = v > 99 ? '99+' : (v > 0 ? String(v) : '');
      if (v > 0) { el.classList.remove('hidden'); el.removeAttribute('hidden'); }
      else { el.classList.add('hidden'); el.setAttribute('hidden',''); }
    });
  }

  var msgBadges   = Array.from(document.querySelectorAll('.nav-unread-messages, a[href="/messages"] .badge'));
  var notifBadges = Array.from(document.querySelectorAll('.nav-unread-notifs, a[href="/notifications"] .indicator .badge, a[href="/notifications"] .badge'));
  var totalBadges = Array.from(document.querySelectorAll('[data-role="nav-unread"]'));

  var msgCount   = Number(<%= (typeof unreadMessages !== 'undefined' ? unreadMessages : 0) %>) || 0;
  var notifCount = Number(<%= (typeof unreadNotificationCount !== 'undefined' ? unreadNotificationCount : 0) %>) || 0;

  setBadge(msgBadges,   msgCount);
  setBadge(notifBadges, notifCount);
  setBadge(totalBadges, msgCount + notifCount);

  socket.on('unread_update', function (p) {
    if (!p || typeof p.unread !== 'number') return;
    msgCount = p.unread;
    setBadge(msgBadges, msgCount);
    setBadge(totalBadges, msgCount + notifCount);
  });

  socket.on('notif_update', function (p) {
    if (!p || typeof p.unread !== 'number') return;
    notifCount = p.unread;
    setBadge(notifBadges, notifCount);
    setBadge(totalBadges, msgCount + notifCount);
  });

  socket.on('new_message', function () {
    msgCount += 1;
    setBadge(msgBadges, msgCount);
    setBadge(totalBadges, msgCount + notifCount);
  });
  socket.on('new_notification', function () {
    notifCount += 1;
    setBadge(notifBadges, notifCount);
    setBadge(totalBadges, msgCount + notifCount);
  });

  // Boost countdowns
  ['boostCountdown','boostCountdownMobile','boostCountdownMenu'].forEach(function(id){
    var el = document.getElementById(id);
    if (!el) return;
    var iso = el.getAttribute('data-expires');
    if (!iso) return;
    var expires = new Date(iso).getTime();
    (function tick(){
      var ms = expires - Date.now();
      if (!isFinite(ms) || ms <= 0) { el.textContent = 'ended'; return; }
      var m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000);
      el.textContent = m + ':' + String(s).padStart(2,'0');
      setTimeout(tick, 1000);
    })();
  });
})();
</script>
