<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', { pageTitle: 'Dashboard' }) %>

  <body class="min-h-screen flex flex-col bg-black text-white relative">
    <!-- Subtle page gradient overlay -->
    <div aria-hidden="true"
         class="pointer-events-none fixed inset-0 bg-[radial-gradient(90%_70%_at_50%_20%,rgba(255,107,107,0.10),transparent_60%),linear-gradient(to_bottom,#0a0a0a,rgba(17,17,17,0.94))]"></div>

    <!-- Navbar (unchanged include) -->
    <%- include('partials/navbar.ejs') %>

    <main class="relative z-10 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 flex-grow">

      <!-- Top strip: likes / boost / plan -->
      <section class="mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Likes remaining -->
          <div class="card bg-black/60 backdrop-blur-xl border border-white/10 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)] rounded-2xl hover:shadow-[0_10px_30px_-10px_rgba(255,107,107,0.3)] transition-shadow">
            <div class="card-body py-4">
              <div class="flex items-center justify-between">
                <div class="text-sm text-white/70">Likes remaining</div>
                <div class="text-2xl font-bold tracking-tight">
                  <span id="likes-count"><%= (typeof likesRemaining === 'number') ? likesRemaining : 'âˆž' %></span>
                </div>
              </div>
              <% if (likesRemaining === 0) { %>
                <p class="text-xs mt-2 text-white/70">
                  Daily limit reached â€” upgrade for unlimited likes.
                </p>
              <% } %>
            </div>
          </div>

          <!-- Boost -->
          <div class="card bg-black/60 backdrop-blur-xl border border-white/10 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)] rounded-2xl hover:shadow-[0_10px_30px_-10px_rgba(255,107,107,0.3)] transition-shadow">
            <div class="card-body py-4 flex items-center justify-between">
              <div>
                <div class="text-sm text-white/70">Visibility</div>
                <div class="text-xs text-white/70">Boost your profile for 30 minutes</div>
              </div>
              <button id="boostBtn"
                      class="btn btn-sm rounded-full text-black border-0 bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl">
                Boost
              </button>
            </div>
          </div>

          <!-- Plan -->
          <div class="card bg-black/60 backdrop-blur-xl border border-white/10 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)] rounded-2xl hover:shadow-[0_10px_30px_-10px_rgba(255,107,107,0.3)] transition-shadow">
            <div class="card-body py-4 flex items-center justify-between">
              <div>
                <div class="text-sm text-white/70">Membership</div>
                <div class="text-xs">
                  Your plan:
                  <span class="font-semibold capitalize bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
                    <%= currentUser.memberLevel || (currentUser.isPremium ? 'silver' : 'free') %>
                  </span>
                </div>
              </div>
              <a href="/upgrade"
                 class="btn btn-sm rounded-full border-white/20 text-black hover:border-white/40 hover:bg-white/5">
                Upgrade
              </a>
            </div>
          </div>
        </div>
      </section>

      <!-- Header row -->
      <section class="mb-4 mt-6 flex items-center justify-between">
        <h2 class="text-xl md:text-2xl font-semibold tracking-tight">
          <span class="bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">Todayâ€™s picks</span>
        </h2>
        <div class="flex items-center gap-2">
          <button id="openFilters"
                  class="btn btn-outline btn-sm rounded-full border-white/20 text-white hover:border-white/40 hover:bg-white/5 open-filters">
            Filters
          </button>
          <a href="/advanced-search"
             class="btn btn-ghost btn-sm rounded-full text-white/80 hover:bg-white/5">
            Advanced
          </a>
        </div>
      </section>

      <!-- Profiles grid -->
      <section aria-label="Profiles">
        <% if ((potentialMatches || []).length === 0) { %>
          <div class="text-center p-12 bg-black/50 backdrop-blur-xl rounded-2xl border border-white/10">
            <p class="text-sm text-white/80">No results. Try widening your filters.</p>
          </div>
        <% } %>

        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
          <% (potentialMatches || []).forEach(function(u){
               const photosArr = Array.isArray(u?.profile?.photos) ? u.profile.photos : [];
               const mainPhoto = photosArr[0] || '/images/default-avatar.png';
          %>
            <article
              class="card bg-black/60 backdrop-blur-xl border border-white/10 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)] hover:shadow-[0_25px_60px_-20px_rgba(255,107,107,0.45)] transition-all rounded-2xl overflow-hidden cursor-pointer focus-within:ring-2 focus-within:ring-[#FF6B6B]/50"
              data-user-id="<%= u._id %>"
              data-href="/users/<%= u._id %>"
              tabindex="0"
              role="link"
              aria-label="Open <%= u.username %>'s profile">

                  <div class="relative">
  <img
    src="<%= mainPhoto %>"
    alt="<%= u.username %> photo"
    class="w-full aspect-[4/5] object-cover"
    loading="lazy">

  <!-- Subtle bottom gradient so badges/chips are always readable -->
  <div class="pointer-events-none absolute inset-x-0 bottom-0 h-20 z-10 bg-gradient-to-t from-black/55 to-transparent"></div>

  <!-- (keep the badge and photo chip blocks below inside this wrapper) -->


                <!-- Favorite star -->
                <button
                  class="btn btn-ghost btn-xs absolute top-2 right-2 rounded-full shadow-sm favorite-toggle <%= u.isFavorite ? 'text-yellow-400' : 'text-white' %> bg-black/50 backdrop-blur border border-white/10"
                  data-user-id="<%= u._id %>"
                  data-id="<%= u._id %>"
                  aria-pressed="<%= u.isFavorite ? 'true' : 'false' %>"
                  title="<%= u.isFavorite ? 'Unfavorite' : 'Favorite' %>">
                  <span aria-hidden="true">â˜…</span>
                  <span class="sr-only"><%= u.isFavorite ? 'Unfavorite' : 'Favorite' %></span>
                </button>

                   <!-- Tier badge -->
<% if (u.memberLevel) { %>
  <span
    class="absolute z-20 top-2 left-2 inline-flex items-center gap-1.5 px-2.5 py-1
           rounded-full text-[11px] font-semibold
           bg-black/75 backdrop-blur-md border border-white/20
           shadow-[0_6px_20px_rgba(0,0,0,0.35)]">
    <svg viewBox="0 0 24 24"
         class="w-4 h-4 <%= u.memberLevel === 'emerald'
                ? 'text-emerald-300'
                : (u.memberLevel === 'silver' ? 'text-slate-200' : 'text-white/80') %>">
      <path fill="currentColor"
            d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z"/>
    </svg>
    <span class="<%= u.memberLevel === 'emerald'
                    ? 'text-emerald-300'
                    : (u.memberLevel === 'silver' ? 'text-slate-100' : 'text-white') %>">
      <%= u.memberLevel %>
    </span>
  </span>
<% } %>

                <!-- Photo count chip (bottom-left corner) -->
<% if (photosArr.length > 1) { %>
  <a
    href="/users/<%= u._id %>#photos"
    class="absolute z-20 bottom-2 left-2 sm:bottom-3 sm:left-3
           inline-flex items-center gap-1.5 px-2.5 py-1.5
           rounded-full text-[11px] font-medium text-white
           bg-black/70 backdrop-blur-md border border-white/15 shadow-lg
           hover:bg-black/80 hover:shadow-xl transition
           pointer-events-auto open-photos"
    title="View photos"
    aria-label="View <%= u.username %>'s photos"
    data-user-id="<%= u._id %>"
    data-username="<%= u.username %>"
    data-photos='<%- JSON.stringify(photosArr).replace(/</g,"\\u003c") %>'>
    <svg viewBox="0 0 24 24" class="w-4 h-4 opacity-90" aria-hidden="true">
      <path fill="currentColor"
            d="M20 6h-2.6l-1.2-1.6c-.2-.3-.5-.4-.8-.4H8.6c-.3 0-.6.1-.8.4L6.6 6H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2Zm-8 12a5 5 0 1 1 0-10a5 5 0 0 1 0 10Zm0-2.2a2.8 2.8 0 1 0 0-5.6a2.8 2.8 0 0 0 0 5.6Z"/>
    </svg>
    <span><%= photosArr.length %> photos</span>
  </a>
<% } %>

              </div>

              <div class="p-3">
                <div class="flex items-center gap-2">
                  <h3 class="text-[16px] font-semibold leading-tight truncate"><%= u.username %>, <%= u.profile?.age || 'â€”' %></h3>
                  <% if (u.isOnline)   { %><span class="badge badge-info badge-xs">Online</span><% } %>
                  <% if (u.verifiedAt) { %><span class="badge badge-success badge-xs">Verified</span><% } %>
                  <% if (u.boostActive){ %><span class="badge badge-primary badge-xs">Boost</span><% } %>
                </div>

                <!-- Meta -->
                <div class="text-xs text-white/70 mt-1 flex items-center gap-1">
                  <svg viewBox="0 0 24 24" class="w-4 h-4 opacity-80" aria-hidden="true">
                    <path fill="currentColor" d="M12 2a7 7 0 0 0-7 7c0 4.97 6.07 11.37 6.33 11.64a1 1 0 0 0 1.34 0C12.93 20.37 19 13.97 19 9a7 7 0 0 0-7-7m0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5Z"/>
                  </svg>
                  <span>
                    <%= [u.profile?.city, u.profile?.stateProvince, u.profile?.country].filter(Boolean).join(', ') || 'â€”' %>
                    <% if (typeof u.distanceKm === 'number') { %>
                      â€¢ <%= Math.round(u.distanceKm) %> km away
                    <% } %>
                  </span>
                </div>

                <% if (u.profile?.bio) { %>
                  <p class="text-sm leading-snug line-clamp-2 mt-2 text-white/90"><%= u.profile.bio %></p>
                <% } %>

                <!-- Actions -->
                <div class="mt-3 grid grid-cols-3 gap-2">
                  <button
                    class="btn btn-xs rounded-full border-white/20 text-white hover:border-white/40 hover:bg-white/5 btn-outline wave-btn"
                    data-user-id="<%= u._id %>"
                    data-id="<%= u._id %>"
                    data-username="<%= u.username %>"
                    <%= u.iWaved ? 'disabled' : '' %>>
                    ðŸ‘‹ <span class="ml-1"><%= u.iWaved ? 'Waved' : 'Wave' %></span>
                  </button>

                  <button
                    class="btn btn-xs rounded-full text-black border-0 bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl like-btn"
                    data-user-id="<%= u._id %>"
                    data-username="<%= u.username %>">
                    <svg viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1" aria-hidden="true">
                      <path d="M3.172 5.172a4.5 4.5 0 016.364 0L10 5.636l.464-.464a4.5 4.5 0 116.364 6.364L10 18.364l-6.828-6.828a4.5 4.5 0 010-6.364z"/>
                    </svg>
                    <span>Like</span>
                  </button>

                  <button
  class="btn btn-xs rounded-full font-semibold text-white
         border border-white/10
         bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
         shadow-md hover:shadow-xl hover:brightness-110 active:brightness-125
         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40
         [@supports(backdrop-filter:blur(0))]:backdrop-blur-sm
         disabled:from-slate-600 disabled:to-slate-500 disabled:text-white disabled:opacity-75"
  data-user-id="<%= u._id %>"
  data-id="<%= u._id %>"
  title="Super-Like (stand out!)"
  <%= u.iSuperLiked ? 'disabled' : '' %>>
  âš¡ <span class="ml-1"><%= u.iSuperLiked ? 'Super-Liked' : 'Super-Like' %></span>
</button>


                <div class="mt-2 flex gap-2">
                  <a class="btn btn-ghost btn-2xs rounded-full text-white/80 hover:bg-white/5" href="/users/<%= u._id %>">View</a>
                  <button class="btn btn-ghost btn-2xs rounded-full text-white/80 hover:bg-white/5 dislike-btn"
                          data-user-id="<%= u._id %>"
                          data-username="<%= u.username %>">
                    Hide
                  </button>
                </div>
              </div>
            </article>
          <% }) %>
        </div>
      </section>

      <!-- Pagination (SSR) -->
      <% if (pageMeta && pageMeta.totalPages > 1) { %>
        <div class="mt-8 flex justify-center items-center gap-3">
          <% const cur = pageMeta.page; const totalPages = pageMeta.totalPages; %>

          <% if (cur > 1) { %>
            <a class="btn btn-sm rounded-full border-white/20 text-white hover:border-white/40 hover:bg-white/5"
               href="?<%= Object.entries({ ...filters, page: cur - 1 })
                       .map(([k,v]) => `${k}=${encodeURIComponent(v||'')}`).join('&') %>">
              Prev
            </a>
          <% } %>

          <span class="text-sm text-white/70">Page <%= cur %> / <%= totalPages %></span>

          <% if (cur < totalPages) { %>
            <a class="btn btn-sm rounded-full border-white/20 text-white hover:border-white/40 hover:bg-white/5"
               href="?<%= Object.entries({ ...filters, page: cur + 1 })
                       .map(([k,v]) => `${k}=${encodeURIComponent(v||'')}`).join('&') %>">
              Next
            </a>
          <% } %>
        </div>
      <% } %>
    </main>

    <!-- Filters dialog (light theme) -->
<dialog id="filtersDialog" class="modal">
  <!-- Force light theme inside the box -->
  <div class="modal-box max-w-3xl bg-base-100 text-base-content border border-base-300 rounded-3xl"
       data-theme="light">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-bold text-lg">Filters</h3>
      <button class="btn btn-ghost btn-sm rounded-full" data-close="filters" aria-label="Close">âœ•</button>
    </div>

    <form id="filtersForm" method="get" class="space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <!-- Core -->
        <label class="form-control">
          <span class="label-text">Seeking gender</span>
          <select name="seekingGender" class="select select-bordered">
            <option value="Any" <%= filters.seekingGender==='Any'?'selected':'' %>>Any</option>
            <option value="Male" <%= filters.seekingGender==='Male'?'selected':'' %>>Male</option>
            <option value="Female" <%= filters.seekingGender==='Female'?'selected':'' %>>Female</option>
            <option value="Non-binary" <%= filters.seekingGender==='Non-binary'?'selected':'' %>>Non-binary</option>
          </select>
        </label>

        <label class="form-control">
          <span class="label-text">Min age</span>
          <input type="number" name="minAge" min="18" max="99"
                 class="input input-bordered"
                 value="<%= filters.minAge || '' %>">
        </label>
        <label class="form-control">
          <span class="label-text">Max age</span>
          <input type="number" name="maxAge" min="18" max="99"
                 class="input input-bordered"
                 value="<%= filters.maxAge || '' %>">
        </label>

        <label class="form-control">
          <span class="label-text">Country</span>
          <input type="text" name="country" class="input input-bordered"
                 value="<%= filters.country || '' %>">
        </label>
        <label class="form-control">
          <span class="label-text">State / Province</span>
          <input type="text" name="stateProvince" class="input input-bordered"
                 value="<%= filters.stateProvince || '' %>">
        </label>
        <label class="form-control">
          <span class="label-text">City</span>
          <input type="text" name="city" class="input input-bordered"
                 value="<%= filters.city || '' %>">
        </label>

        <label class="form-control sm:col-span-2">
          <span class="label-text">Search text</span>
          <input type="text" name="q" class="input input-bordered"
                 value="<%= filters.q || '' %>" placeholder="bio, username">
        </label>

        <label class="form-control sm:col-span-2">
          <span class="label-text">Interests</span>
          <input type="text" name="interests" class="input input-bordered"
                 value="<%= filters.interests || '' %>" placeholder="comma separated">
        </label>

        <!-- Toggles -->
        <label class="label cursor-pointer">
          <span class="label-text">Verified only</span>
          <input type="checkbox" name="verifiedOnly" value="1" class="toggle toggle-primary"
                 <%= filters.verifiedOnly === '1' ? 'checked' : '' %> >
        </label>

        <label class="label cursor-pointer">
          <span class="label-text">Online now</span>
          <input type="checkbox" name="onlineNow" value="1" class="toggle toggle-primary"
                 <%= filters.onlineNow === '1' ? 'checked' : '' %> >
        </label>

        <label class="label cursor-pointer">
          <span class="label-text">Has photo</span>
          <input type="checkbox" name="hasPhoto" value="1" class="toggle toggle-primary"
                 <%= filters.hasPhoto === '1' ? 'checked' : '' %> >
        </label>

        <label class="form-control">
          <span class="label-text">Min photos</span>
          <select name="minPhotos" class="select select-bordered">
            <option value="">Any</option>
            <option value="2" <%= filters.minPhotos==='2'?'selected':'' %>>2+</option>
            <option value="3" <%= filters.minPhotos==='3'?'selected':'' %>>3+</option>
            <option value="4" <%= filters.minPhotos==='4'?'selected':'' %>>4+</option>
          </select>
        </label>

        <!-- Radius -->
        <label class="form-control">
          <span class="label-text">Radius (km)</span>
          <input type="number" min="1" max="5000" name="radiusKm"
                 class="input input-bordered"
                 value="<%= filters.radiusKm || '' %>" placeholder="e.g., 50">
        </label>

        <!-- Religion / Denomination -->
        <label class="form-control">
          <span class="label-text">Religion</span>
          <input type="text" name="religion" class="input input-bordered"
                 value="<%= filters.religion || '' %>">
        </label>
        <label class="form-control">
          <span class="label-text">Denomination</span>
          <input type="text" name="denomination" class="input input-bordered"
                 value="<%= filters.denomination || '' %>">
        </label>

        <!-- Languages -->
        <label class="form-control sm:col-span-2">
          <span class="label-text">Languages (comma separated)</span>
          <input type="text" name="languages" class="input input-bordered"
                 value="<%= Array.isArray(filters.languages)?filters.languages.join(', '):(filters.languages||'') %>"
                 placeholder="e.g., English, Swahili, Yoruba">
        </label>

        <!-- Lifestyle -->
        <label class="form-control">
          <span class="label-text">Education</span>
          <input type="text" name="education" class="input input-bordered"
                 value="<%= filters.education || '' %>">
        </label>
        <label class="form-control">
          <span class="label-text">Smoking</span>
          <input type="text" name="smoking" class="input input-bordered"
                 value="<%= filters.smoking || '' %>">
        </label>
        <label class="form-control">
          <span class="label-text">Drinking</span>
          <input type="text" name="drinking" class="input input-bordered"
                 value="<%= filters.drinking || '' %>">
        </label>

        <!-- Sort -->
        <label class="form-control">
          <span class="label-text">Sort by</span>
          <select name="sort" class="select select-bordered">
            <option value="active"   <%= filters.sort==='active'?'selected':'' %>>Active first</option>
            <option value="recent"   <%= filters.sort==='recent'?'selected':'' %>>Newest</option>
            <option value="distance" <%= filters.sort==='distance'?'selected':'' %>>Nearest</option>
            <option value="ageAsc"   <%= filters.sort==='ageAsc'?'selected':'' %>>Age â†‘</option>
            <option value="ageDesc"  <%= filters.sort==='ageDesc'?'selected':'' %>>Age â†“</option>
          </select>
        </label>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <a class="btn btn-ghost rounded-full" href="/dashboard">Reset</a>
        <button class="btn rounded-full text-black border-0 bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl" type="submit">
          Apply
        </button>
      </div>
    </form>
  </div>
</dialog>


    <!-- Generic UI modal (glass) -->
    <dialog id="uiModal" class="modal">
      <div class="modal-box bg-black/70 backdrop-blur-2xl border border-white/10 rounded-3xl text-black">
        <div class="flex items-center justify-between">
          <h3 id="uiModalTitle" class="font-bold text-lg">Info</h3>
          <button class="btn btn-ghost btn-sm rounded-full text-white/80 hover:bg-white/10" data-modal-close aria-label="Close">âœ•</button>
        </div>
        <p id="uiModalBody" class="py-4">Done.</p>
        <div class="modal-action">
          <button class="btn rounded-full text-black border-0 bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl" data-modal-close>
            OK
          </button>
        </div>
      </div>
    </dialog>

    <!-- Photo lightbox (glass) -->
    <dialog id="photoLightbox" class="modal">
      <div class="modal-box max-w-3xl p-0 overflow-hidden bg-black/80 backdrop-blur-2xl border border-white/10 rounded-3xl">
        <div class="relative bg-black">
          <img id="photoImg" src="" alt="" class="w-full max-h-[80vh] object-contain transition-transform duration-200" />
          <button id="photoPrev" class="absolute left-2 top-1/2 -translate-y-1/2 btn btn-circle">â€¹</button>
          <button id="photoNext" class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-circle">â€º</button>
          <button class="absolute right-2 top-2 btn btn-sm rounded-full text-black/80 hover:bg-white/10" data-close="photoLightbox">âœ•</button>
        </div>
        <div class="p-3 flex items-center justify-between gap-2 text-black">
          <div class="text-sm"><span id="photoCaption"></span></div>
          <a id="photoProfileLink" class="btn btn-outline btn-sm rounded-full border-white/30 text-black hover:border-white/50 hover:bg-white/5" href="#">View profile</a>
        </div>
      </div>
    </dialog>

    <!-- Footer include (unchanged) -->
    <%- include('partials/footer.ejs') %>

    <!-- JS (unchanged wiring) -->
    <script src="/socket.io/socket.io.js" defer></script>
    <script src="/js/socket-helper.js" defer></script>
    <script src="/js/dashboard.js" defer></script>
  </body>
</html>
