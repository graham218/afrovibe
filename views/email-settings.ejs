<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <!-- keep your head partial so fonts/meta/CSP stay consistent -->
  <%- include('partials/head.ejs', { pageTitle: 'Email Settings' }) %>

  <body class="min-h-screen flex flex-col bg-[#000] text-white relative isolation-isolate">
    <!-- navbar stays on top of any page overlays -->
    <%- include('partials/navbar.ejs') %>

    <!-- subtle page glow (doesn‚Äôt touch navbar/footer) -->
    <div aria-hidden="true"
         class="pointer-events-none absolute inset-0 -z-10
                bg-[radial-gradient(60%_50%_at_50%_0%,rgba(255,107,107,.12),transparent_60%),radial-gradient(60%_40%_at_80%_100%,rgba(254,202,87,.10),transparent_60%)]">
    </div>

    <main class="flex-1">
      <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
        <!-- header card -->
        <div class="mb-6 md:mb-8">
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
            <span class="bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
              Email Settings
            </span>
          </h1>
          <p class="mt-2 text-sm text-white/80">
            Update the email tied to your account. We‚Äôll ask for your password to confirm it‚Äôs you.
          </p>
        </div>

        <!-- main glass card -->
        <div class="rounded-3xl bg-black/60 backdrop-blur-xl border border-white/10 shadow-[0_12px_40px_-12px_rgba(0,0,0,.65)]">
          <div class="p-5 md:p-8 space-y-6">
            <!-- current email display -->
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm">
                <div class="text-white/70">Current email</div>
                <div class="mt-1 font-semibold break-all">
                  <span id="currentEmail" class="px-2.5 py-1 rounded-full text-sm
                               bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] text-black">
                    <%= currentUser && currentUser.email ? currentUser.email : '' %>
                  </span>
                </div>
              </div>

              <button id="copyEmailBtn"
                      type="button"
                      class="btn btn-sm rounded-full text-black border-0
                             bg-gradient-to-r from-[#FECA57] to-[#FF6B6B]
                             hover:shadow-xl hover:scale-[1.02] transition">
                üìã Copy
              </button>
            </div>

            <!-- form -->
            <form id="emailForm" class="space-y-5" method="post" action="/update-email">
              <!-- new email -->
              <label class="form-control w-full">
                <span class="label-text mb-1 text-white/80">New email</span>
                <input
                  type="email"
                  name="newEmail"
                  id="newEmail"
                  placeholder="you@newmail.com"
                  required
                  class="input input-bordered w-full bg-black/40 text-black placeholder-white/40
                         border-white/20 focus:border-transparent
                         focus:outline-none focus:ring-2 focus:ring-[#FF6B6B]"/>
                <p id="emailHint" class="mt-1 text-xs text-black/60 hidden">Looks good ‚úÖ</p>
              </label>

              <!-- password -->
              <label class="form-control w-full">
                <span class="label-text mb-1 text-white/80">Confirm password</span>
                <div class="relative">
                  <input
                    type="password"
                    name="password"
                    id="password"
                    placeholder="Enter your current password"
                    required
                    class="input input-bordered w-full bg-black/40 text-black placeholder-white/40
                           border-white/20 pr-12
                           focus:border-transparent focus:outline-none focus:ring-2 focus:ring-[#FECA57]" />
                  <button type="button"
                          id="togglePwd"
                          class="absolute right-2.5 top-1/2 -translate-y-1/2 text-black/70 hover:text-black">
                    üëÅ
                  </button>
                </div>
              </label>

              <!-- actions -->
              <div class="flex items-center justify-between gap-3 pt-1">
                <a href="/settings"
                   class="btn btn-ghost rounded-full text-white/80 hover:bg-white/10">
                  ‚Üê Back to Settings
                </a>

                <button type="submit"
                        id="submitBtn"
                        class="btn rounded-full text-black border-0
                               bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
                               hover:shadow-xl hover:scale-[1.02] transition">
                  <span class="inline-flex items-center gap-2">
                    <span class="hidden" id="spinner" aria-hidden="true"
                          class="loading loading-spinner loading-xs"></span>
                    Save email
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- tiny tips card -->
        <div class="mt-6 rounded-2xl bg-black/50 backdrop-blur-xl border border-white/10 p-4 text-xs text-white/70">
          <div class="font-semibold mb-1">Tips</div>
          <ul class="list-disc pl-5 space-y-1">
            <li>We‚Äôll send a verification link to your new email.</li>
            <li>If you can‚Äôt access your old email, contact support from the app.</li>
          </ul>
        </div>
      </section>
    </main>

    <%- include('partials/footer.ejs') %>

    <!-- lightweight modal (uses your existing partial if present) -->
    <dialog id="alertModal" class="modal">
      <div class="modal-box bg-black/70 backdrop-blur-2xl border border-white/10 rounded-3xl text-white">
        <h3 id="alertTitle" class="font-bold text-lg bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
          Notice
        </h3>
        <p id="alertMessage" class="py-3 text-white/90">‚Äî</p>
        <div class="modal-action">
          <button class="btn rounded-full text-black border-0 bg-gradient-to-r from-[#FECA57] to-[#FF6B6B]" data-modal-close>
            Close
          </button>
        </div>
      </div>
    </dialog>

    <!-- scripts (no inline handlers; CSP-friendly) -->
    <script>
      // modal open helper
      function showAlertModal(title, message) {
        const m = document.getElementById('alertModal');
        const t = document.getElementById('alertTitle');
        const b = document.getElementById('alertMessage');
        if (!m) return;
        if (t) t.textContent = title || 'Notice';
        if (b) b.textContent = message || '';
        try { m.showModal(); } catch {}
      }
      // modal close (delegated)
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-modal-close]');
        if (!btn) return;
        btn.closest('dialog')?.close();
      });

      // copy email
      (function () {
        const btn = document.getElementById('copyEmailBtn');
        const el  = document.getElementById('currentEmail');
        if (!btn || !el) return;
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(el.textContent.trim());
            showAlertModal('Copied', 'Current email copied to clipboard.');
          } catch {
            showAlertModal('Failed', 'Could not copy. Select and copy manually.');
          }
        });
      })();

      // password toggle
      (function () {
        const t = document.getElementById('togglePwd');
        const i = document.getElementById('password');
        if (!t || !i) return;
        t.addEventListener('click', () => {
          i.type = i.type === 'password' ? 'text' : 'password';
        });
      })();

      // live email validation hint
      (function () {
        const input = document.getElementById('newEmail');
        const hint  = document.getElementById('emailHint');
        if (!input || !hint) return;
        const rx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        input.addEventListener('input', () => {
          const ok = rx.test(input.value.trim());
          hint.classList.toggle('hidden', !ok);
        });
      })();

      // submit (AJAX to keep UX smooth; falls back to form action if fetch fails)
      (function () {
        const form = document.getElementById('emailForm');
        const btn  = document.getElementById('submitBtn');
        const spn  = document.getElementById('spinner');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          const newEmail = String(fd.get('newEmail') || '').trim();
          const password = String(fd.get('password') || '').trim();
          if (!newEmail || !password) {
            showAlertModal('Error', 'Please fill in all fields.'); return;
          }
          btn?.setAttribute('disabled', 'true');
          spn?.classList.remove('hidden');

          try {
            const res = await fetch('/update-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              credentials: 'same-origin',
              body: new URLSearchParams({ newEmail, password }).toString()
            });
            const json = await res.json().catch(() => ({}));
            if (res.ok && json?.success) {
              showAlertModal('Success', json.message || 'Email updated.');
              setTimeout(() => location.reload(), 1200);
            } else {
              showAlertModal('Error', json?.message || 'Could not update email.');
            }
          } catch {
            showAlertModal('Error', 'Network error. Please try again.');
          } finally {
            btn?.removeAttribute('disabled');
            spn?.classList.add('hidden');
          }
        });
      })();
    </script>
  </body>
</html>
