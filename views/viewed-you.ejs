<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', { pageTitle: 'Who Viewed You' }) %>
  <body class="min-h-screen flex flex-col bg-black text-white selection:bg-[#FF6B6B]/30 selection:text-white">
    <!-- Navbar -->
    <%- include('partials/navbar.ejs', { currentUser, unreadMessages, unreadNotificationCount }) %>

    <!-- Main -->
    <main class="relative isolation-isolate z-10 flex-1 max-w-6xl w-full mx-auto px-4 md:px-6 lg:px-8 py-6 md:py-10">
      <!-- page-only background overlay (keeps navbar/footer readable) -->
      <div aria-hidden="true"
           class="pointer-events-none absolute inset-0 -z-10
                  bg-[radial-gradient(60%_50%_at_50%_0%,rgba(255,107,107,.12),transparent_60%),radial-gradient(60%_40%_at_80%_100%,rgba(254,202,87,.10),transparent_60%)]">
      </div>

      <!-- Header -->
      <header class="mb-6 md:mb-8 flex items-center justify-between">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight
                     bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
            Who Viewed You
          </h1>
          <p class="mt-1 text-sm opacity-80">Premium unlocks the full list of people who checked you out.</p>
        </div>

        <% if (blurred) { %>
          <div class="flex items-center gap-2">
            <a href="/upgrade"
               class="btn rounded-full border-0 text-black
                      bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
                      hover:shadow-xl hover:scale-[1.02] transition">
              Upgrade to unlock
            </a>
          </div>
        <% } else { %>
          <div class="flex items-center gap-2">
            <span class="badge badge-success badge-sm rounded-full border-0 bg-emerald-500/20 text-emerald-300">Unlocked</span>
            <a href="/upgrade"
               class="btn btn-ghost btn-sm rounded-full border border-white/10 text-white/80 hover:bg-white/10">
              Manage plan
            </a>
          </div>
        <% } %>
      </header>

      <!-- Empty state -->
      <% if (!people || !people.length) { %>
        <section class="rounded-3xl border border-white/10 bg-black/60 backdrop-blur-xl p-8 text-center">
          <div class="mx-auto w-14 h-14 rounded-full bg-gradient-to-br from-[#FF6B6B] to-[#FECA57] grid place-items-center shadow-lg">
            <svg viewBox="0 0 24 24" class="w-7 h-7 text-black" aria-hidden="true">
              <path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7s11-7 11-7s-4-7-11-7m0 12a5 5 0 1 1 0-10a5 5 0 0 1 0 10Z"/>
            </svg>
          </div>
          <h2 class="mt-4 text-xl font-semibold">No views yet</h2>
          <p class="mt-1 text-sm opacity-75">Be active and your profile will show up more often!</p>
          <a href="/dashboard"
             class="mt-6 inline-flex items-center gap-2 rounded-full px-5 py-2 text-sm text-black
                    bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl transition">
            Discover people
          </a>
        </section>
      <% } %>

      <!-- Grid -->
      <section class="grid gap-5 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <% (people || []).forEach(u => { %>
          <article class="relative group rounded-3xl overflow-hidden
                          border border-white/10 bg-black/60 backdrop-blur-xl
                          shadow-[0_12px_40px_-12px_rgba(0,0,0,.6)]
                          hover:shadow-[0_16px_50px_-12px_rgba(0,0,0,.75)]
                          transition-transform duration-300 hover:-translate-y-0.5">
            <% if (blurred) { %>
              <div class="absolute inset-0 z-20 backdrop-blur-md bg-black/50 grid place-items-center">
                <div class="text-center">
                  <div class="mx-auto w-10 h-10 rounded-full bg-white/10 grid place-items-center">
                    <svg viewBox="0 0 24 24" class="w-5 h-5 text-white/80" aria-hidden="true">
                      <path fill="currentColor" d="M12 1a10 10 0 0 0-7.07 17.07L12 25l7.07-6.93A10 10 0 0 0 12 1m0 4a2 2 0 0 1 2 2v3h-4V7a2 2 0 0 1 2-2m-4 7h8a4 4 0 1 1-8 0Z"/>
                    </svg>
                  </div>
                  <div class="mt-2 text-xs opacity-80">Upgrade to see who viewed you</div>
                  <a href="/upgrade"
                     class="mt-3 inline-flex items-center gap-2 rounded-full px-4 py-1.5 text-sm text-black
                            bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl transition">
                    Upgrade
                  </a>
                </div>
              </div>
            <% } %>

            <!-- Photo -->
            <figure class="overflow-hidden">
              <img src="<%= (u.profile?.photos?.[0] || '/img/placeholder.png') %>"
                   alt="<%= u.username %>"
                   class="w-full aspect-[4/5] object-cover transform transition
                          duration-500 ease-out group-hover:scale-105">
            </figure>

            <!-- Body -->
            <div class="p-3">
              <div class="flex items-center gap-2">
                <span class="inline-block w-2 h-2 rounded-full <%= (u.lastActive && (Date.now()-new Date(u.lastActive).getTime() < 5*60*1000)) ? 'bg-emerald-400 shadow-[0_0_0_3px_rgba(16,185,129,.15)]' : 'bg-white/30' %>"></span>
                <h3 class="text-[16px] font-semibold leading-tight truncate
                           bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
                  <%= u.username %>
                </h3>
              </div>

              <div class="text-xs opacity-80 mt-1">
                <%= u.profile?.age ? (u.profile.age + ' Â· ') : '' %>
                <%= [u.profile?.city, u.profile?.country].filter(Boolean).join(', ') %>
              </div>

              <div class="mt-3 grid grid-cols-2 gap-2">
                <a class="btn btn-ghost btn-xs rounded-full border border-white/10 text-white/90 hover:bg-white/10"
                   href="/users/<%= u._id %>">View</a>

                <!-- keep like-btn hook -->
                <button class="btn btn-xs like-btn rounded-full text-black border-0
                               bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
                               hover:shadow-xl hover:scale-[1.02] transition"
                        data-id="<%= u._id %>">ðŸ’œ Like</button>
              </div>
            </div>
          </article>
        <% }) %>
      </section>

      <!-- Pagination -->
      <% if (pageMeta && pageMeta.totalPages > 1) { %>
        <nav class="mt-8 flex justify-center gap-2" aria-label="Pagination">
          <% for (let p = 1; p <= pageMeta.totalPages; p++) { %>
            <a href="/viewed-you?page=<%= p %>&limit=<%= pageMeta.limit %>"
               class="inline-flex items-center justify-center px-4 h-9 rounded-full text-sm
                      <%= p === pageMeta.page
                           ? 'text-black bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] shadow-xl'
                           : 'border border-white/10 bg-black/60 backdrop-blur text-white/80 hover:bg-white/10' %>">
              <%= p %>
            </a>
          <% } %>
        </nav>
      <% } %>
    </main>

    <!-- Footer -->
    <%- include('partials/footer.ejs') %>

    <!-- Scripts (kept) -->
    <script nonce="<%= cspNonce %>" src="/js/socket.helper.js" defer></script>
    <script nonce="<%= cspNonce %>" src="/js/global.js" defer></script>
    <!-- If your like handler lives here, keep it -->
    <script nonce="<%= cspNonce %>" src="/js/page-dashboard.js" defer></script>
  </body>
</html>
