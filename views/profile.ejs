<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', { pageTitle: (user?.username ? user.username + " Profile" : "Profile") }) %>

  <body class="min-h-screen flex flex-col bg-black text-black bg-[radial-gradient(60%_40%_at_50%_0%,#0f0f0f_0%,#0a0a0a_45%,#000_100%)]">
    <%- include('partials/navbar.ejs') %>

    <div class="container mx-auto px-4 py-6 flex-grow">
      <main
        class="max-w-6xl mx-auto w-full"
        data-viewed-id="<%= String(user._id) %>"
      >

        <!-- Unified Success Flash -->
        <% const _success = (typeof successMessage !== 'undefined' && successMessage) ? successMessage
                      : ((typeof success !== 'undefined' && success) ? success : null); %>
        <% if (_success) { %>
          <div class="alert shadow-xl max-w-2xl mx-auto my-6
                      bg-black/60 backdrop-blur-xl border border-white/10 text-white">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-400" viewBox="0 0 24 24" fill="none">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="font-medium"><%= _success %></span>
            </div>
          </div>
        <% } %>

        <% if (isBlocked) { %>
          <div class="alert shadow-xl max-w-2xl mx-auto my-8
                      bg-black/60 backdrop-blur-xl border border-white/10 text-white">
            <div class="flex items-center gap-3">
              <svg class="w-6 h-6 text-rose-400" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>This user is blocked. You cannot interact with a blocked user.</span>
            </div>
          </div>
        <% } else { %>

          <!-- Profile Card (glass) -->
          <div class="max-w-4xl mx-auto rounded-3xl shadow-2xl p-6 md:p-8 space-y-8
                      bg-black/60 backdrop-blur-xl border border-white/10">

            <!-- Header: Avatar + Basic Info -->
            <div class="flex flex-col md:flex-row items-center md:items-start gap-6 md:gap-8">

              <!-- Profile Picture -->
              <div class="relative w-44 h-44 md:w-64 md:h-64 rounded-2xl overflow-hidden border border-white/10 shadow-xl">
                <% const _photos = (user?.profile?.photos && user.profile.photos.length) ? user.profile.photos : []; %>
                <% if (_photos.length) { %>
                  <img src="<%= _photos[0] %>" alt="<%= user.username %>" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105 select-none">
                <% } else { %>
                  <img src="/images/default-avatar.png" alt="No photo" class="w-full h-full object-cover select-none opacity-90">
                <% } %>

                <!-- subtle inner glow -->
                <div class="pointer-events-none absolute inset-0 shadow-[inset_0_0_40px_rgba(255,255,255,0.06)]"></div>
              </div>

              <!-- Profile Info -->
              <div class="flex-grow text-center md:text-left w-full">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">
                    <span
                      class="bg-gradient-to-r from-[#FF6B6B] via-[#FECA57] to-[#FF9A56] bg-clip-text text-transparent"
                    ><%= user.username %></span>
                    <% if (user?.profile?.age) { %>
                      <span class="text-white/70 font-medium">, <%= user.profile.age %></span>
                    <% } %>
                  </h1>

                  <!-- Single normalized membership badge -->
                  <%
                    const _plan = (user?.plan && user.plan !== 'free') ? String(user.plan).toLowerCase()
                                 : (user?.isPremium ? 'premium' : 'free');
                  %>
                  <% if (_plan === 'elite') { %>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold
                                 bg-black/60 backdrop-blur border border-white/10 text-white">
                      <span class="i">‚ú®</span> Elite
                    </span>
                  <% } else if (_plan === 'premium') { %>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold
                                 bg-black/60 backdrop-blur border border-white/10 text-white">
                      <span class="i">‚úÖ</span> Premium
                    </span>
                  <% } else { %>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold
                                 bg-white/10 border border-white/10 text-white/90">
                      Free
                    </span>
                  <% } %>
                </div>

                <%
                  const locStr = (user?.profile?.location)
                    ? user.profile.location
                    : [user?.profile?.city, user?.profile?.country].filter(Boolean).join(', ');
                %>
                <% if (locStr) { %>
                  <p class="text-base md:text-lg text-white/70 mt-1"><%= locStr %></p>
                <% } %>

                <!-- Action Buttons -->
                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-6">

                  <a href="/chat/<%= user._id %>"
                     class="btn rounded-full text-black border-0
                            bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl hover:scale-[1.02] transition">
                    Message
                  </a>

                  <!-- Keep IDs/logic intact; only visuals -->
                  <button id="btnLike"
                          class="btn btn-outline rounded-full border-white/20 text-white hover:bg-white/10"
                          title="<%= hasLiked ? 'Unlike' : 'Like' %>">
                    <svg id="iconLike" viewBox="0 0 24 24"
                         class="h-5 w-5 <%= hasLiked ? 'text-rose-400' : 'text-white/70' %>">
                      <path d="M12 21s-7.2-4.35-10-8.4C-.11 9.64 1.64 6 5 6c1.9 0 3.1.93 4 2 0 0 1.8-2 4-2 3.36 0 5.11 3.64 3 6.6C19.2 16.65 12 21 12 21z" fill="currentColor"/>
                    </svg>
                    <span class="hidden sm:inline"><%= hasLiked ? 'Liked' : 'Like' %></span>
                  </button>

                  <button id="btnSuperlike"
                          class="btn btn-xs sm:btn-sm rounded-full text-black border-0
                                 bg-gradient-to-r from-[#FECA57] to-[#FF6B6B] hover:shadow-xl hover:scale-[1.02] transition">
                    ‚ö° <span class="hidden sm:inline">Super-like</span>
                  </button>

                  <button id="btnWave"
                          class="btn btn-outline rounded-full border-white/20 text-white hover:bg-white/10">
                    üëã <span class="hidden sm:inline">Wave</span>
                  </button>

                  <button id="btnFavorite"
                          class="btn btn-outline rounded-full border-white/20 text-white hover:bg-white/10">
                    ‚≠ê <span class="hidden sm:inline">Favorite</span>
                  </button>

                  <button id="btnCall"
                          class="btn btn-ghost rounded-full text-white hover:bg-white/10">
                    üìπ Call
                  </button>

                    <button id="btnReport"
  class="btn btn-outline rounded-full
         !bg-white/10 !text-white !border-white/40 backdrop-blur-sm
         transition-all duration-200
         hover:!bg-gradient-to-r hover:!from-[#FECA57] hover:!to-[#FF6B6B]
         hover:!text-black hover:!border-transparent hover:shadow-xl
         focus:outline-none focus:ring-2 focus:ring-white/40">
  Report
</button>

<button id="btnBlock"
  class="btn btn-outline rounded-full
         !bg-white/10 !text-white !border-white/40 backdrop-blur-sm
         transition-all duration-200
         hover:!bg-gradient-to-r hover:!from-[#FECA57] hover:!to-[#FF6B6B]
         hover:!text-black hover:!border-transparent hover:shadow-xl
         focus:outline-none focus:ring-2 focus:ring-white/40">
  Block
</button>

                </div>
              </div>
            </div>

            <!-- About / Details -->
            <div class="mt-4 text-white">
              <h3 class="text-xl md:text-2xl font-bold mb-2
                         bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
                About Me
              </h3>
              <p class="text-sm md:text-base text-white/80 leading-relaxed mb-4">
                <%= (user?.profile?.bio) ? user.profile.bio : 'No bio provided.' %>
              </p>

              <!-- Chips for Interests -->
              <% const _interests = Array.isArray(user?.profile?.interests) ? user.profile.interests.slice(0,12) : []; %>
              <% if (_interests.length) { %>
                <div class="flex flex-wrap gap-2 mb-4">
                  <% _interests.forEach(function(tag){ %>
                    <span class="px-3 py-1 rounded-full text-xs font-medium
                                 bg-black/50 backdrop-blur border border-white/10 text-white/90">
                      <%= tag %>
                    </span>
                  <% }) %>
                </div>
              <% } %>

              <!-- Basics -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="space-y-1">
                  <p><span class="text-white/60">Gender:</span> <span class="text-white/90"><%= user?.profile?.gender || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Age:</span> <span class="text-white/90"><%= user?.profile?.age || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Lives in:</span> <span class="text-white/90"><%= locStr || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Occupation:</span> <span class="text-white/90"><%= user?.profile?.occupation || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Education:</span> <span class="text-white/90"><%= user?.profile?.educationLevel || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Languages:</span>
                    <span class="text-white/90"><%= (user?.profile?.languagesSpoken || user?.profile?.languages || []).join(', ') || '‚Äî' %></span>
                  </p>
                </div>
                <div class="space-y-1">
                  <p><span class="text-white/60">Religion:</span> <span class="text-white/90"><%= user?.profile?.religion || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Smoking:</span> <span class="text-white/90"><%= user?.profile?.smokes || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Drinking:</span> <span class="text-white/90"><%= user?.profile?.drinks || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Pets:</span> <span class="text-white/90"><%= (user?.profile?.pets||[]).join(', ') || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Body art:</span> <span class="text-white/90"><%= (user?.profile?.bodyArt||[]).join(', ') || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Looking for:</span> <span class="text-white/90"><%= (user?.profile?.relationshipLookingFor||[]).join(', ') || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Children:</span> <span class="text-white/90"><%= user?.profile?.children || '‚Äî' %></span></p>
                  <p><span class="text-white/60">Wants more children:</span> <span class="text-white/90"><%= user?.profile?.wantsMoreChildren || '‚Äî' %></span></p>
                </div>
                <div class="md:col-span-2">
                  <p><span class="text-white/60">Hobbies & Interests:</span>
                    <span class="text-white/90"><%= (user?.profile?.hobbiesInterests||[]).join(', ') || '‚Äî' %></span>
                  </p>
                </div>
              </div>

              <!-- Highlights (prompts) -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                <div class="rounded-2xl p-4 bg-black/50 backdrop-blur border border-white/10">
                  <div class="text-xs text-white/60 mb-1">Favorite African artists</div>
                  <div class="text-white/90"><%= user?.favoriteAfricanArtists || '‚Äî' %></div>
                </div>
                <div class="rounded-2xl p-4 bg-black/50 backdrop-blur border border-white/10">
                  <div class="text-xs text-white/60 mb-1">Cultural traditions</div>
                  <div class="text-white/90"><%= user?.culturalTraditions || '‚Äî' %></div>
                </div>
                <div class="rounded-2xl p-4 md:col-span-2 bg-black/50 backdrop-blur border border-white/10">
                  <div class="text-xs text-white/60 mb-1">Relationship goals</div>
                  <div class="text-white/90"><%= user?.relationshipGoals || '‚Äî' %></div>
                </div>
              </div>
            </div>

            <!-- Photos -->
            <div class="divider my-8 before:bg-white/10 after:bg-white/10 text-white/60">Photos</div>
            <div class="photo-gallery grid grid-cols-2 md:grid-cols-3 gap-4">
              <% if (_photos.length) { %>
                <% _photos.forEach(function(photo){ %>
                  <div class="relative rounded-2xl overflow-hidden border border-white/10 bg-black/40">
                    <img src="<%= photo %>" alt="Photo of <%= user.username %>"
                         class="w-full h-48 object-cover transition-transform duration-300 hover:scale-105 select-none">
                    <div class="pointer-events-none absolute inset-0 shadow-[inset_0_0_40px_rgba(255,255,255,0.06)]"></div>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="photo-placeholder col-span-full text-center text-white/60 italic">
                  <span>No photos available</span>
                </div>
              <% } %>
            </div>

          </div> <!-- /Profile Card -->
        <% } %> <!-- /if not blocked -->

      </main>
    </div> <!-- /container -->

    <!-- Block Modal (glass) -->
    <dialog id="blockModal" class="modal">
      <div class="modal-box rounded-3xl bg-black/70 backdrop-blur-2xl border border-white/10 text-black">
        <h3 class="font-bold text-lg">Confirm Block</h3>
        <p class="py-4 text-black/80">Are you sure you want to block this user? They will be removed from your visibility.</p>
        <div class="modal-action">
          <form id="blockForm" action="/block/<%= user._id %>" method="POST">
            <button type="submit"
              class="btn rounded-full border-0 text-black bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl">
              Block
            </button>
          </form>
          <button type="button" class="btn btn-ghost rounded-full text-white/80 hover:bg-white/10" id="blockCancelBtn">Cancel</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Report Modal (legacy, kept intact but styled) -->
    <dialog id="reportModal" class="modal">
      <div class="modal-box rounded-3xl bg-black/70 backdrop-blur-2xl border border-white/10 text-black">
        <h2 class="font-bold text-lg">Report User</h2>
        <p class="py-4 text-black/80">Please provide a reason for reporting this user.</p>
        <form id="reportForm" action="/report/<%= user._id %>" method="POST">
          <textarea name="reason" class="textarea textarea-bordered w-full bg-black/40 border-white/20 text-black" placeholder="Reason for reporting" required></textarea>
          <div class="modal-action">
            <button type="submit"
                    class="btn rounded-full border-0 text-black bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl">
              Submit Report
            </button>
            <button type="button" class="btn btn-ghost rounded-full text-white/80 hover:bg-white/10" id="reportCancelBtn">Cancel</button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Newer Report Dialog (kept; just styled) -->
    <dialog id="reportDialog" class="modal">
      <div class="modal-box rounded-3xl bg-black/70 backdrop-blur-2xl border border-white/10 text-black">
        <form id="reportForm" method="dialog">
          <h3 class="font-semibold mb-2">Report <%= user.username %></h3>
          <p class="text-sm text-white/70 mb-3">Tell us what happened. Our team will review.</p>

          <label class="form-control">
            <span class="label-text text-black/80">Reason</span>
            <select name="reason" class="select select-bordered w-full bg-black/40 border-white/20 text-black" required>
              <option value="">Select‚Ä¶</option>
              <option value="spam">Spam</option>
              <option value="fake_profile">Fake profile</option>
              <option value="harassment">Harassment</option>
              <option value="inappropriate_content">Inappropriate content</option>
              <option value="other">Other</option>
            </select>
          </label>

          <label class="form-control mt-3">
            <span class="label-text text-white/80">Details</span>
            <textarea name="details" rows="4"
                      class="textarea textarea-bordered w-full bg-black/40 border-white/20 text-white"
                      placeholder="Add any helpful details‚Ä¶"></textarea>
          </label>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button type="button" class="btn btn-ghost rounded-full text-white/80 hover:bg-white/10" id="reportCancelBtn">Cancel</button>
            <button type="submit"
                    class="btn rounded-full border-0 text-black bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] hover:shadow-xl">
              Submit report
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <%- include('partials/modals.ejs') %>
    <%- include('partials/footer.ejs') %>

    <!-- Page JS (CSP-safe) -->
    <script nonce="<%= cspNonce || '' %>">
      document.addEventListener('DOMContentLoaded', () => {
        // Like
        document.querySelectorAll('.like-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const userId = e.currentTarget.getAttribute('data-user-id');
            try {
              const response = await fetch(`/like/${userId}`, { method: 'POST' });
              const result = await response.json().catch(()=>({}));
              if (result.status === 'match') {
                alert('It‚Äôs a match! üéâ');
              } else if (result.status === 'error') {
                showAlertModal('Error', result.message || 'Could not like user');
              } else {
                showAlertModal('Success', 'User liked!');
              }
            } catch (err) {
              console.error('Error liking user:', err);
              showAlertModal('Error', 'Failed to like user');
            }
          });
        });

        // Dislike
        document.querySelectorAll('.dislike-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const userId = e.currentTarget.getAttribute('data-user-id');
            try {
              const response = await fetch(`/dislike/${userId}`, { method: 'POST' });
              const result = await response.json().catch(()=>({}));
              if (result.status === 'error') {
                showAlertModal('Error', result.message || 'Could not dislike user');
              } else {
                showAlertModal('Success', 'User disliked!');
              }
            } catch (err) {
              console.error('Error disliking user:', err);
              showAlertModal('Error', 'Failed to dislike user');
            }
          });
        });

        // Report Modal open/close
        const reportModal = document.getElementById('reportModal');
        const btnReportOpen = document.getElementById('btnReportOpen');
        const reportCancelBtn = document.getElementById('reportCancelBtn');
        if (btnReportOpen && reportModal) {
          btnReportOpen.addEventListener('click', () => { try { reportModal.showModal(); } catch {} });
        }
        if (reportCancelBtn && reportModal) {
          reportCancelBtn.addEventListener('click', () => { try { reportModal.close(); } catch {} });
        }

        // Block Modal open/close
        const blockModal = document.getElementById('blockModal');
        const btnBlockOpen = document.getElementById('btnBlockOpen');
        const blockCancelBtn = document.getElementById('blockCancelBtn');
        if (btnBlockOpen && blockModal) {
          btnBlockOpen.addEventListener('click', () => { try { blockModal.showModal(); } catch {} });
        }
        if (blockCancelBtn && blockModal) {
          blockCancelBtn.addEventListener('click', () => { try { blockModal.close(); } catch {} });
        }
      });

      // Minimal modal helpers (in case your partial isn't present)
      function showAlertModal(title, message) {
        const modal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        if (modal && alertTitle && alertMessage && modal.showModal) {
          alertTitle.innerText = title;
          alertMessage.innerText = message;
          modal.showModal();
        } else {
          alert(title + ": " + message);
        }
      }
    </script>

    <script src="/js/profile.js" defer></script>
  </body>
</html>
