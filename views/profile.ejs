<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', { pageTitle: (user?.username ? user.username + " Profile" : "Profile") }) %>
  <body class="bg-base-100 min-h-screen flex flex-col">
    <%- include('partials/navbar.ejs') %>

    <div class="container mx-auto p-4 flex-grow">
      <main class="max-w-6xl mx-auto p-4 md:p-6 w-full flex-1"
      data-viewed-id="<%= String(user._id) %>">

      <!-- Unified Success Flash -->
      <% const _success = (typeof successMessage !== 'undefined' && successMessage) ? successMessage
                    : ((typeof success !== 'undefined' && success) ? success : null); %>
      <% if (_success) { %>
        <div class="alert alert-success shadow-lg max-w-2xl mx-auto my-6">
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span><%= _success %></span>
          </div>
        </div>
      <% } %>

      <% if (isBlocked) { %>
        <div class="alert alert-error shadow-lg max-w-2xl mx-auto my-8">
          <div>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>This user is blocked. You cannot interact with a blocked user.</span>
          </div>
        </div>
      <% } else { %>

        <!-- Profile Card -->
        <div class="max-w-4xl mx-auto bg-base-200 p-8 rounded-2xl shadow-xl space-y-8">

          <!-- Header: Avatar + Basic Info -->
          <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">

            <!-- Profile Picture -->
            <div class="relative w-48 h-48 md:w-64 md:h-64 rounded-full overflow-hidden shadow-lg border-4 border-primary">
              <% const _photos = (user?.profile?.photos && user.profile.photos.length) ? user.profile.photos : []; %>
              <% if (_photos.length) { %>
                <img src="<%= _photos[0] %>" alt="<%= user.username %>" class="w-full h-full object-cover select-none">
              <% } else { %>
                <img src="/images/default-avatar.png" alt="No photo" class="w-full h-full object-cover select-none">
              <% } %>
            </div>

            <!-- Profile Info -->
            <div class="flex-grow text-center md:text-left w-full">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <h1 class="text-4xl font-extrabold text-primary truncate">
                  <%= user.username %>
                  <% if (user?.profile?.age) { %>
                    <span class="text-gray-600 font-normal">, <%= user.profile.age %></span>
                  <% } %>
                </h1>

                <!-- Single normalized membership badge -->
                <%
                  const _plan = (user?.plan && user.plan !== 'free') ? String(user.plan).toLowerCase()
                               : (user?.isPremium ? 'premium' : 'free');
                %>
                <% if (_plan === 'elite') { %>
                  <span class="badge badge-secondary badge-lg">Elite ‚ú®</span>
                <% } else if (_plan === 'premium') { %>
                  <span class="badge badge-success badge-lg">Premium ‚úÖ</span>
                <% } else { %>
                  <span class="badge badge-ghost badge-lg">Free</span>
                <% } %>
              </div>

              <%
                const locStr = (user?.profile?.location)
                  ? user.profile.location
                  : [user?.profile?.city, user?.profile?.country].filter(Boolean).join(', ');
              %>
              <% if (locStr) { %>
                <p class="text-xl text-base-content/70 mt-1"><%= locStr %></p>
              <% } %>

              <!-- Action Buttons -->
              <div class="flex flex-wrap justify-center md:justify-start gap-4 mt-6">
  <a href="/chat/<%= user._id %>" class="btn btn-secondary">Message</a>

  <!-- Like / Super-like / Wave / Favorite -->
  <button id="btnLike" class="btn btn-primary" title="<%= hasLiked ? 'Unlike' : 'Like' %>">
    <svg id="iconLike" viewBox="0 0 24 24" class="h-5 w-5 <%= hasLiked ? 'text-rose-600' : 'text-base-content/70' %>">
      <path d="M12 21s-7.2-4.35-10-8.4C-.11 9.64 1.64 6 5 6c1.9 0 3.1.93 4 2 0 0 1.8-2 4-2 3.36 0 5.11 3.64 3 6.6C19.2 16.65 12 21 12 21z" fill="currentColor"/>
    </svg>
    <span class="hidden sm:inline"><%= hasLiked ? 'Liked' : 'Like' %></span>
  </button>

  <button id="btnSuperlike" class="btn btn-outline btn-sm">‚ö° <span class="hidden sm:inline">Super-like</span></button>
  <button id="btnWave"       class="btn btn-outline btn-sm">üëã <span class="hidden sm:inline">Wave</span></button>
  <button id="btnFavorite"   class="btn btn-outline btn-sm">‚≠ê <span class="hidden sm:inline">Favorite</span></button>

  <!-- Request video call (the script handles gating/errors) -->
  <button id="btnCall" class="btn btn-ghost btn-sm">üìπ Call</button>

  <!-- Report / Block -->
  <button id="btnReport" class="btn btn-warning btn-outline btn-sm">Report</button>
  <button id="btnBlock"  class="btn btn-error btn-outline btn-sm">Block</button>
</div>

            </div>
          </div>

          <!-- About / Details -->
          <div class="mt-6 text-base-content">
            <h3 class="text-2xl font-bold mb-2">About Me</h3>
            <p class="text-md mb-4"><%= (user?.profile?.bio) ? user.profile.bio : 'No bio provided.' %></p>

            <!-- Chips for Interests -->
            <% const _interests = Array.isArray(user?.profile?.interests) ? user.profile.interests.slice(0,12) : []; %>
            <% if (_interests.length) { %>
              <div class="flex flex-wrap gap-2 mb-4">
                <% _interests.forEach(function(tag){ %>
                  <span class="badge badge-outline"><%= tag %></span>
                <% }) %>
              </div>
            <% } %>

            <!-- Basics (expanded to match edit-profile/my-profile fields) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div class="space-y-1">
                <p><span class="opacity-70">Gender:</span> <%= user?.profile?.gender || '‚Äî' %></p>
                <p><span class="opacity-70">Age:</span> <%= user?.profile?.age || '‚Äî' %></p>
                <p><span class="opacity-70">Lives in:</span> <%= locStr || '‚Äî' %></p>
                <p><span class="opacity-70">Occupation:</span> <%= user?.profile?.occupation || '‚Äî' %></p>
                <p><span class="opacity-70">Education:</span> <%= user?.profile?.educationLevel || '‚Äî' %></p>
                <p><span class="opacity-70">Languages:</span> <%= (user?.profile?.languagesSpoken || user?.profile?.languages || []).join(', ') || '‚Äî' %></p>
              </div>
              <div class="space-y-1">
                <p><span class="opacity-70">Religion:</span> <%= user?.profile?.religion || '‚Äî' %></p>
                <p><span class="opacity-70">Smoking:</span> <%= user?.profile?.smokes || '‚Äî' %></p>
                <p><span class="opacity-70">Drinking:</span> <%= user?.profile?.drinks || '‚Äî' %></p>
                <p><span class="opacity-70">Pets:</span> <%= (user?.profile?.pets||[]).join(', ') || '‚Äî' %></p>
                <!-- Newly mirrored fields -->
                <p><span class="opacity-70">Body art:</span> <%= (user?.profile?.bodyArt||[]).join(', ') || '‚Äî' %></p>
                <p><span class="opacity-70">Looking for:</span> <%= (user?.profile?.relationshipLookingFor||[]).join(', ') || '‚Äî' %></p>
                <p><span class="opacity-70">Children:</span> <%= user?.profile?.children || '‚Äî' %></p>
                <p><span class="opacity-70">Wants more children:</span> <%= user?.profile?.wantsMoreChildren || '‚Äî' %></p>
              </div>
              <div class="md:col-span-2">
                <p><span class="opacity-70">Hobbies & Interests:</span>
                  <%= (user?.profile?.hobbiesInterests||[]).join(', ') || '‚Äî' %>
                </p>
              </div>
            </div>

            <!-- Highlights (prompts) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
              <div class="rounded-xl bg-base-100 border p-4">
                <div class="text-xs opacity-70 mb-1">Favorite African artists</div>
                <div><%= user?.favoriteAfricanArtists || '‚Äî' %></div>
              </div>
              <div class="rounded-xl bg-base-100 border p-4">
                <div class="text-xs opacity-70 mb-1">Cultural traditions</div>
                <div><%= user?.culturalTraditions || '‚Äî' %></div>
              </div>
              <div class="rounded-xl bg-base-100 border p-4 md:col-span-2">
                <div class="text-xs opacity-70 mb-1">Relationship goals</div>
                <div><%= user?.relationshipGoals || '‚Äî' %></div>
              </div>
            </div>
          </div>

          <!-- Photos -->
          <div class="divider">Photos</div>
          <div class="photo-gallery grid grid-cols-2 md:grid-cols-3 gap-4">
            <% if (_photos.length) { %>
              <% _photos.forEach(function(photo){ %>
                <img src="<%= photo %>" alt="Photo of <%= user.username %>" class="w-full h-48 object-cover rounded-xl shadow select-none">
              <% }); %>
            <% } else { %>
              <div class="photo-placeholder col-span-full text-center text-base-content/60 italic">
                <span>No photos available</span>
              </div>
            <% } %>
          </div>

        </div> <!-- /Profile Card -->
      <% } %> <!-- /if not blocked -->
    </div> <!-- /container -->

    <!-- Block Modal -->
    <dialog id="blockModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Confirm Block</h3>
        <p class="py-4">Are you sure you want to block this user? They will be removed from your visibility.</p>
        <div class="modal-action">
          <form id="blockForm" action="/block/<%= user._id %>" method="POST">
            <button type="submit" class="btn btn-error">Block</button>
          </form>
          <button type="button" class="btn btn-ghost" id="blockCancelBtn">Cancel</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Report Modal -->
    <dialog id="reportModal" class="modal">
      <div class="modal-box">
        <h2 class="font-bold text-lg">Report User</h2>
        <p class="py-4">Please provide a reason for reporting this user.</p>
        <form id="reportForm" action="/report/<%= user._id %>" method="POST">
          <textarea name="reason" class="textarea textarea-bordered w-full" placeholder="Reason for reporting" required></textarea>
          <div class="modal-action">
            <button type="submit" class="btn btn-primary">Submit Report</button>
            <button type="button" class="btn btn-ghost" id="reportCancelBtn">Cancel</button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>
    <dialog id="reportDialog" class="modal">
  <div class="modal-box">
    <form id="reportForm" method="dialog">
      <h3 class="font-semibold mb-2">Report <%= user.username %></h3>
      <p class="text-sm opacity-70 mb-3">Tell us what happened. Our team will review.</p>

      <label class="form-control">
        <span class="label-text">Reason</span>
        <select name="reason" class="select select-bordered w-full" required>
          <option value="">Select‚Ä¶</option>
          <option value="spam">Spam</option>
          <option value="fake_profile">Fake profile</option>
          <option value="harassment">Harassment</option>
          <option value="inappropriate_content">Inappropriate content</option>
          <option value="other">Other</option>
        </select>
      </label>
      <label class="form-control mt-3">
        <span class="label-text">Details</span>
        <textarea name="details" rows="4" class="textarea textarea-bordered w-full" placeholder="Add any helpful details‚Ä¶"></textarea>
      </label>

      <div class="mt-4 flex items-center justify-end gap-2">
        <button type="button" class="btn btn-ghost" id="reportCancelBtn">Cancel</button>
        <button type="submit" class="btn btn-error">Submit report</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>


    <%- include('partials/modals.ejs') %>
    <%- include('partials/footer.ejs') %>

    <!-- Page JS (CSP-safe) -->
    <script nonce="<%= cspNonce || '' %>">
      document.addEventListener('DOMContentLoaded', () => {
        // Like
        document.querySelectorAll('.like-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const userId = e.currentTarget.getAttribute('data-user-id');
            try {
              const response = await fetch(`/like/${userId}`, { method: 'POST' });
              const result = await response.json().catch(()=>({}));
              if (result.status === 'match') {
                alert('It‚Äôs a match! üéâ'); // or open your match modal if present
              } else if (result.status === 'error') {
                showAlertModal('Error', result.message || 'Could not like user');
              } else {
                showAlertModal('Success', 'User liked!');
              }
            } catch (err) {
              console.error('Error liking user:', err);
              showAlertModal('Error', 'Failed to like user');
            }
          });
        });

        // Dislike
        document.querySelectorAll('.dislike-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const userId = e.currentTarget.getAttribute('data-user-id');
            try {
              const response = await fetch(`/dislike/${userId}`, { method: 'POST' });
              const result = await response.json().catch(()=>({}));
              if (result.status === 'error') {
                showAlertModal('Error', result.message || 'Could not dislike user');
              } else {
                showAlertModal('Success', 'User disliked!');
              }
            } catch (err) {
              console.error('Error disliking user:', err);
              showAlertModal('Error', 'Failed to dislike user');
            }
          });
        });

        // Report Modal open/close
        const reportModal = document.getElementById('reportModal');
        const btnReportOpen = document.getElementById('btnReportOpen');
        const reportCancelBtn = document.getElementById('reportCancelBtn');
        if (btnReportOpen && reportModal) {
          btnReportOpen.addEventListener('click', () => { try { reportModal.showModal(); } catch {} });
        }
        if (reportCancelBtn && reportModal) {
          reportCancelBtn.addEventListener('click', () => { try { reportModal.close(); } catch {} });
        }

        // Block Modal open/close
        const blockModal = document.getElementById('blockModal');
        const btnBlockOpen = document.getElementById('btnBlockOpen');
        const blockCancelBtn = document.getElementById('blockCancelBtn');
        if (btnBlockOpen && blockModal) {
          btnBlockOpen.addEventListener('click', () => { try { blockModal.showModal(); } catch {} });
        }
        if (blockCancelBtn && blockModal) {
          blockCancelBtn.addEventListener('click', () => { try { blockModal.close(); } catch {} });
        }
      });

      // Minimal modal helpers (in case your partial isn't present)
      function showAlertModal(title, message) {
        const modal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        if (modal && alertTitle && alertMessage && modal.showModal) {
          alertTitle.innerText = title;
          alertMessage.innerText = message;
          modal.showModal();
        } else {
          alert(title + ": " + message);
        }
      }
    </script>
    <script src="/js/profile.js" defer></script>
  </body>
</html>
