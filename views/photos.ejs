<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', { pageTitle: 'Manage Photos' }) %>
  <body class="bg-base-100 min-h-screen flex flex-col">
    <%- include('partials/navbar.ejs') %>

    <div class="container mx-auto p-4 flex-grow">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-primary mt-8 mb-2">Manage Photos</h1>
      <p class="text-center text-gray-600 mb-8">Upload and manage up to 5 photos for your profile.</p>

      <div class="max-w-2xl mx-auto bg-base-200 p-5 sm:p-8 rounded-2xl shadow-xl space-y-8">
        <!-- Upload -->
        <form id="uploadForm" action="/photos/upload" method="POST" enctype="multipart/form-data" class="space-y-4">
          <div class="form-control w-full">
            <label for="profilePhotos" class="label">
              <span class="label-text">Upload Photos (max 5)</span>
            </label>
            <input
              type="file"
              name="profilePhotos"
              id="profilePhotos"
              accept="image/*"
              class="file-input file-input-bordered w-full"
              multiple
              required />
          </div>
          <button type="submit" class="btn btn-primary w-full">Upload</button>
        </form>

        <!-- Gallery -->
        <div>
          <h2 class="text-2xl font-semibold mb-4">Your Photos</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <% if (userPhotos && userPhotos.length > 0) { %>
              <% userPhotos.forEach((photo, idx) => { %>
                <div class="card bg-base-100 shadow-md">
                  <figure>
                    <img src="<%= photo %>" alt="User photo" class="w-full aspect-[4/5] object-cover" />
                  </figure>
                  <div class="card-body p-4">
                    <!-- Uses :photoIndex route -->
                    <form action="/photos/delete/<%= idx %>" method="POST" class="deleteForm">
                      <button type="submit" class="btn btn-sm btn-error w-full">Delete</button>
                    </form>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <p class="text-gray-500 col-span-full text-center">You have no photos uploaded yet.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <%- include('partials/modals.ejs') %>
    <%- include('partials/footer.ejs') %>

    <script nonce="<%= cspNonce || '' %>">
      // Simple toast-like modal helper (expects partials/modals.ejs to define #alertModal)
      function alertModal(title, message) {
        const modal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        if (modal && alertTitle && alertMessage) {
          alertTitle.innerText = title;
          alertMessage.innerText = message;
          modal.classList.add('modal-open');
          setTimeout(() => modal.classList.remove('modal-open'), 1600);
        } else {
          // Fallback
          alert(title + ': ' + message);
        }
      }

      // Upload via fetch -> JSON response from POST /photos/upload
      document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const fd = new FormData(form);

        try {
          const r = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
          const j = await r.json();
          if (j.status === 'success') {
            alertModal('Success', j.message || 'Uploaded');
            setTimeout(() => location.reload(), 800);
          } else {
            alertModal('Error', j.message || 'Upload failed');
          }
        } catch (err) {
          console.error(err);
          alertModal('Error', 'Failed to upload photos.');
        }
      });

      // Delete: post to each form's action (/photos/delete/:photoIndex) and expect JSON
      document.querySelectorAll('.deleteForm').forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            const r = await fetch(form.action, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: '', // no body needed for :photoIndex route
              credentials: 'same-origin'
            });
            const j = await r.json();
            if (j.status === 'success') {
              alertModal('Deleted', j.message || 'Photo deleted.');
              setTimeout(() => location.reload(), 500);
            } else {
              alertModal('Error', j.message || 'Delete failed.');
            }
          } catch (err) {
            console.error(err);
            alertModal('Error', 'Failed to delete photo.');
          }
        });
      });
    </script>
  </body>
</html>
