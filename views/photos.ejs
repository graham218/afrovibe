<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', { pageTitle: 'Manage Photos' }) %>
  <body class="bg-black text-white min-h-screen flex flex-col">
    <%- include('partials/navbar.ejs') %>

    <main class="flex-1">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Header -->
        <header class="mb-6 md:mb-8">
          <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
            <span class="bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">
              Manage Photos
            </span>
          </h1>
          <p class="mt-2 text-sm md:text-base text-white/80">
            Upload and manage up to <span class="font-semibold">5</span> photos for your profile.
          </p>
        </header>

        <!-- Glass container -->
        <section class="rounded-3xl bg-black/60 backdrop-blur-xl border border-white/10 shadow-[0_12px_40px_-12px_rgba(0,0,0,.6)] hover:shadow-[0_16px_50px_-12px_rgba(0,0,0,.75)] transition-shadow">
          <div class="p-5 md:p-8 space-y-8">

            <!-- Upload -->
            <form id="uploadForm" action="/photos/upload" method="POST" enctype="multipart/form-data" class="space-y-4">
              <div class="flex items-center justify-between gap-3">
                <div class="text-sm text-white/70">
                  <span class="inline-flex items-center gap-2">
                    <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
                    Accepted: JPG, PNG, WebP â€¢ Max 5 photos
                  </span>
                </div>
                <div id="photoCount" class="text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10">
                  <%= (userPhotos && userPhotos.length) ? userPhotos.length : 0 %>/5 used
                </div>
              </div>

              <!-- Drop zone -->
              <label for="profilePhotos"
                     id="dropZone"
                     class="group relative rounded-2xl border border-dashed border-white/20 bg-black/40 hover:bg-black/50 transition-colors
                            px-4 py-6 md:py-10 grid place-items-center text-center cursor-pointer">
                <div class="pointer-events-none">
                  <div class="mx-auto mb-3 grid place-items-center">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] text-black grid place-items-center shadow-xl">
                      <span class="text-xl">â¤´</span>
                    </div>
                  </div>
                  <div class="text-sm md:text-base">
                    <span class="font-medium">Drag & drop</span> or <span class="underline decoration-white/40">choose files</span>
                  </div>
                  <div class="text-xs text-white/60 mt-1">Up to 5 photos. You can reorder later.</div>
                </div>

                <input
                  type="file"
                  name="profilePhotos"
                  id="profilePhotos"
                  accept="image/*"
                  class="sr-only"
                  multiple
                  required />
              </label>

              <!-- Live preview (pre-upload) -->
              <div id="previewGrid" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>

              <div class="flex items-center justify-end gap-3">
                <a href="/my-profile"
                   class="btn btn-ghost rounded-full text-white/80 hover:bg-white/10">
                  Cancel
                </a>
                <button type="submit"
                        class="btn rounded-full text-black border-0
                               bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
                               hover:shadow-xl hover:scale-[1.02] active:scale-[0.99] transition">
                  Upload
                </button>
              </div>
            </form>

            <!-- Gallery -->
            <div>
              <h2 class="text-lg md:text-xl font-semibold mb-3">
                <span class="bg-gradient-to-r from-[#FF6B6B] to-[#FECA57] bg-clip-text text-transparent">Your Photos</span>
              </h2>

              <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                <% if (userPhotos && userPhotos.length > 0) { %>
                  <% userPhotos.forEach((photo, idx) => { %>
                    <div class="group rounded-2xl overflow-hidden bg-black/60 backdrop-blur-xl border border-white/10 shadow-sm hover:shadow-xl transition
                                hover:border-white/20">
                      <figure class="relative">
                        <img src="<%= photo %>"
                             alt="User photo"
                             class="w-full aspect-[4/5] object-cover transition-transform duration-300 group-hover:scale-105" />

                        <!-- Set profile photo (optional CTA) -->
                        <div class="absolute bottom-2 left-2 text-[10px] px-2 py-1 rounded-full bg-black/60 backdrop-blur border border-white/10">
                          Profile photo
                        </div>
                      </figure>

                      <div class="p-3 grid grid-cols-2 gap-2">
  <!-- Set profile -->
  <form action="/photos/set-primary/<%= idx %>" method="POST" class="setPrimaryForm">
    <button type="submit"
      class="btn btn-xs w-full rounded-full text-black border-0
             bg-gradient-to-r from-[#FF6B6B] to-[#FECA57]
             hover:shadow-xl hover:scale-[1.03] active:scale-[0.98] transition">
      Set as Profile
    </button>
  </form>
                        <!-- Uses /photos/delete/:photoIndex route -->
                        <form action="/photos/delete/<%= idx %>" method="POST" class="deleteForm">
                          <button type="submit"
                                  class="btn btn-xs w-full rounded-full text-black border-0
                                         bg-gradient-to-r from-[#ff4d4d] to-[#ff7a7a]
                                         hover:shadow-xl hover:scale-[1.03] active:scale-[0.98] transition">
                            Delete
                          </button>
                        </form>
                      </div>
                    </div>
                  <% }); %>
                <% } else { %>
                  <div class="col-span-full">
                    <div class="rounded-2xl bg-black/60 backdrop-blur-xl border border-white/10 p-8 text-center">
                      <div class="mb-3 grid place-items-center">
                        <div class="w-12 h-12 rounded-full bg-white/10 border border-white/10 grid place-items-center">
                          <span class="text-xl">ðŸ“·</span>
                        </div>
                      </div>
                      <p class="text-white/80">You have no photos uploaded yet.</p>
                      <p class="text-white/60 text-sm mt-1">Add at least one so people can discover you.</p>
                    </div>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <%- include('partials/modals.ejs') %>
    <%- include('partials/footer.ejs') %>

    <script nonce="<%= cspNonce || '' %>">
      // Lightweight toast-like modal helper
      function alertModal(title, message) {
        const modal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        if (modal && alertTitle && alertMessage) {
          alertTitle.innerText = title;
          alertMessage.innerText = message;
          modal.classList.add('modal-open');
          setTimeout(() => modal.classList.remove('modal-open'), 1600);
        } else {
          alert(title + ': ' + message);
        }
      }

      // --- Drag & drop + live preview (pre-upload) ---
      const dz = document.getElementById('dropZone');
      const fi = document.getElementById('profilePhotos');
      const pg = document.getElementById('previewGrid');
      const counter = document.getElementById('photoCount');

      function updateUsedCount(extra = 0) {
        try {
          const used = Number(<%= (userPhotos && userPhotos.length) ? userPhotos.length : 0 %>);
          const val = used + extra;
          if (counter) counter.textContent = (val > 5 ? 5 : val) + '/5 used';
        } catch {}
      }

      function renderPreviews(files) {
        if (!pg) return;
        pg.innerHTML = '';
        const chosen = Array.from(files || []).slice(0, 5); // soft cap
        if (!chosen.length) { pg.classList.add('hidden'); updateUsedCount(0); return; }

        chosen.forEach((file) => {
          const url = URL.createObjectURL(file);
          const wrap = document.createElement('div');
          wrap.className = 'rounded-xl overflow-hidden border border-white/10 bg-black/50';
          wrap.innerHTML = '<img class="w-full aspect-[4/5] object-cover" alt="Preview" />';
          wrap.querySelector('img').src = url;
          pg.appendChild(wrap);
        });

        pg.classList.remove('hidden');
        updateUsedCount(chosen.length);
      }

      function acceptFiles(flist) {
        // Merge with any already chosen (let browser handle duplicates)
        if (fi && flist?.length) {
          // We cannot programmatically set a FileList easily; just preview.
          renderPreviews(flist);
        }
      }

      fi?.addEventListener('change', (e) => renderPreviews(e.currentTarget.files));

      ;['dragenter', 'dragover'].forEach(ev =>
        dz?.addEventListener(ev, (e) => {
          e.preventDefault(); e.stopPropagation();
          dz.classList.add('ring-2', 'ring-white/30');
        })
      );
      ;['dragleave', 'drop'].forEach(ev =>
        dz?.addEventListener(ev, (e) => {
          e.preventDefault(); e.stopPropagation();
          dz.classList.remove('ring-2', 'ring-white/30');
        })
      );
      dz?.addEventListener('drop', (e) => acceptFiles(e.dataTransfer?.files));

      // --- Submit via fetch -> expects JSON from POST /photos/upload ---
      document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const fd = new FormData(form);

        try {
          const r = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
          // If server sends JSON (recommended)
          const ct = r.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
            const j = await r.json();
            if (j.status === 'success') {
              alertModal('Success', j.message || 'Uploaded');
              setTimeout(() => location.reload(), 800);
            } else {
              alertModal('Error', j.message || 'Upload failed');
            }
          } else {
            // Fallback: assume success if 200/201
            if (r.ok) {
              alertModal('Success', 'Uploaded');
              setTimeout(() => location.reload(), 800);
            } else {
              alertModal('Error', 'Upload failed');
            }
          }
        } catch (err) {
          console.error(err);
          alertModal('Error', 'Failed to upload photos.');
        }
      });

      document.querySelectorAll('.setPrimaryForm').forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const r = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: '',
          credentials: 'same-origin'
        });
        const j = await r.json().catch(() => ({}));
        if (r.ok && j.ok) {
          alertModal('Updated', 'Profile photo set.');
          // quick optimistic UI: add a small badge to the first card, or just reload
          setTimeout(() => location.reload(), 500);
        } else {
          alertModal('Error', j.message || 'Failed to set profile photo.');
        }
      } catch (err) {
        console.error(err);
        alertModal('Error', 'Failed to set profile photo.');
      }
    });
  });

      // --- Delete (POST /photos/delete/:photoIndex) -> JSON expected ---
      document.querySelectorAll('.deleteForm').forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            const r = await fetch(form.action, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: '', // none needed for :photoIndex route
              credentials: 'same-origin'
            });
            const ct = r.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              const j = await r.json();
              if (j.status === 'success') {
                alertModal('Deleted', j.message || 'Photo deleted.');
                setTimeout(() => location.reload(), 500);
              } else {
                alertModal('Error', j.message || 'Delete failed.');
              }
            } else if (r.ok) {
              alertModal('Deleted', 'Photo deleted.');
              setTimeout(() => location.reload(), 500);
            } else {
              alertModal('Error', 'Delete failed.');
            }
          } catch (err) {
            console.error(err);
            alertModal('Error', 'Failed to delete photo.');
          }
        });
      });

      // Respect reduced motion
      try {
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          document.querySelectorAll('img, .btn').forEach(el => el.classList.remove('transition', 'hover:scale-[1.02]', 'hover:scale-[1.03]'));
        }
      } catch {}
    </script>
  </body>
</html>
