<%-
/**
 * views/blocked.ejs
 * Locals:
 *  - currentUser
 *  - targetUser       (optional; show confirm card)
 *  - blockedUsers[]   (optional; show grid of cards)
 *  - unreadMessages, unreadNotificationCount (optional for navbar)
 *  - pageTitle (optional)
 */
-%>
<!DOCTYPE html>
<html lang="en" data-theme="afrovibe">
  <%- include('partials/head.ejs', {
        pageTitle: (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : 'Blocked users'
      }) %>
  <body class="bg-base-100 min-h-screen flex flex-col">
    <%- include('partials/navbar.ejs') %>

    <main class="max-w-6xl mx-auto w-full p-4 md:p-6 flex-1">
      <!-- Header -->
      <header class="mb-5">
        <h1 class="text-2xl font-bold">Safety · Blocked users</h1>
        <p class="text-sm opacity-70">You won’t see or interact with people you’ve blocked.</p>
      </header>

      <!-- Confirm block (compact) -->
      <% if (targetUser) {
           const raw = targetUser?.profile?.photos?.[0];
           const avatar = raw ? (raw.startsWith('/') ? raw : ('/' + raw)) : '/images/default-avatar.png';
      %>
        <section class="card bg-base-100 border shadow mb-6">
          <div class="card-body">
            <h2 class="card-title">Confirm block</h2>

            <div class="flex items-start gap-3">
              <div class="w-12 h-12 rounded-full overflow-hidden ring ring-base-300 ring-offset-2 shrink-0">
                <img src="<%= avatar %>" class="w-full h-full object-cover" alt="<%= targetUser.username %> avatar" data-fallback="/images/default-avatar.png">
              </div>

              <div class="min-w-0">
                <div class="font-semibold leading-tight truncate"><%= targetUser.username %></div>
                <div class="text-xs opacity-70 leading-tight">
                  <%= [targetUser?.profile?.city, targetUser?.profile?.country].filter(Boolean).join(', ') || '—' %>
                </div>
                <p class="text-sm mt-2 opacity-80">
                  Blocking removes likes/matches in both directions and hides you from each other.
                </p>

                <form action="/block/<%= String(targetUser._id) %>" method="POST" class="mt-3 flex items-center gap-2">
                  <label class="form-control w-full md:max-w-sm">
                    <span class="label-text text-xs">Reason (optional)</span>
                    <textarea name="reason" rows="2" class="textarea textarea-bordered textarea-sm" placeholder="Spam, fake profile, harassment…"></textarea>
                  </label>

                  <div class="shrink-0 flex items-center gap-2">
                    <button type="submit" class="btn btn-error btn-sm">Block</button>
                    <a href="/users/<%= String(targetUser._id) %>" class="btn btn-ghost btn-sm">Cancel</a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>
      <% } %>

      <!-- Blocked list (GRID CARDS, small avatar) -->
      <section class="card bg-base-100 border shadow">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <h2 class="card-title">Blocked users</h2>
            <% if (Array.isArray(blockedUsers) && blockedUsers.length) { %>
              <span class="badge badge-ghost"><%= blockedUsers.length %></span>
            <% } %>
          </div>

          <% if (Array.isArray(blockedUsers) && blockedUsers.length) { %>
            <div class="mt-3 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
              <% blockedUsers.forEach(function(u) {
                   const raw = u?.profile?.photos?.[0];
                   const ava = raw ? (raw.startsWith('/') ? raw : ('/' + raw)) : '/images/default-avatar.png';
              %>
                <article class="border border-base-300 rounded-2xl p-3 bg-base-100 hover:shadow-sm transition-shadow">
                  <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden ring ring-base-300 ring-offset-2 shrink-0">
                      <img src="<%= ava %>" class="w-full h-full object-cover" alt="<%= u.username %> avatar" data-fallback="/images/default-avatar.png">
                    </div>

                    <div class="min-w-0 flex-1">
                      <div class="font-medium leading-tight truncate"><%= u.username %></div>
                      <div class="text-xs opacity-70 truncate">
                        <%= [u?.profile?.city, u?.profile?.country].filter(Boolean).join(', ') || '—' %>
                      </div>

                      <form action="/unblock/<%= String(u._id) %>" method="POST" class="mt-3">
                        <button type="submit" class="btn btn-outline btn-xs">Unblock</button>
                      </form>
                    </div>
                  </div>
                </article>
              <% }) %>
            </div>
          <% } else { %>
            <div class="text-sm opacity-70">You haven’t blocked anyone yet.</div>
          <% } %>
        </div>
      </section>
    </main>

    <%- include('partials/footer.ejs') %>
  </body>
</html>
